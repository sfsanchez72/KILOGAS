#!/usr/bin/perl
use PDL::Core;
use PDL::Graphics::Gnuplot;
use PDL::Basic;
use PDL::Primitive;
use Math::FFT;
use Math::Stat;
use Math::Spline qw(spline linsearch binsearch);
use Math::Derivative qw(Derivative2);
use Math::Approx;
use Astro::FITS::CFITSIO qw( :longnames :constants );
use PDL;
use PDL::Fit::Polynomial; 
use PDL::Filter::Linear;
use PGPLOT;  # Load PGPLOT module
use PDL::Fit::Gaussian;
use PDL::Slatec;
use PDL::Image2D;
use Statistics::OLS;
use PDL::Transform::Color;

use Statistics::R;
use Graphics::Gnuplot::Palettes qw(palette palette_names);
use PDL::IO::Pic;
use warnings;
no warnings "all";
use PDL::Graphics::PLplot;
use PDL::NiceSlice;

require("./my_ARAA_BPT_maps_den.pl");


print "Reading proc_elines files\n";


$n_CALIFA=0;
$n_MUSE=0;
$n_SAMI=0;
$n_MaNGA=0;
$n=0;
$SAMPLE_NOW="CALIFA";;
@name_CALIFA=read_get_proc($get_proc_CALIFA);
$n_CALIFA=$n;
print "CALIFA, $n_CALIFA\n";
$SAMPLE_NOW="MaNGA";;
@name_MaNGA=read_get_proc($get_proc_MaNGA);
$n_MaNGA=$n-$n_CALIFA;
print "MaNGA, $n_MaNGA\n";
$SAMPLE_NOW="SAMI";;
@name_SAMI=read_get_proc($get_proc_SAMI);
$n_SAMI=$n-$n_CALIFA-$n_MaNGA;
print "SAMI, $n_SAMI\n";
$SAMPLE_NOW="MUSE";
@name_MUSE=read_get_proc($get_proc_MUSE);
$n_MUSE=$n-$n_CALIFA-$n_MaNGA-$n_SAMI;
print "MUSE, $n_MUSE\n"; 

my @name=(@name_CALIFA,@name_MaNGA,@name_SAMI,@name_MUSE);
print "$n total cubes\n";


#
# READ PROC_ELINES
#
print "Reading mag_files files\n";


read_get_mag($get_mag_cubes_CALIFA);
read_get_mag($get_mag_cubes_MaNGA);
read_get_mag($get_mag_cubes_SAMI);
read_get_mag($get_mag_cubes_MUSE);
def_tables_get_mag();


#print "$name[0],$name[1000],$name[6000]";
#print "$name_CALIFA[0],$name_MaNGA[0],@name_CALIFA";

my @x;
my @x_2;
my @x_3;
my @e_x;
my @e_x_2;
my @e_x_3;
my @y;
my @e_y;
my @color;

##################################################################
# End reading tables
##################################################################



##################################################################
# Reading morphological tables!
##################################################################
#
# Morphology
#

#@morph_name=("E0","E1","E2","E3","E4","E5","E6","E7","S0","S0a","Sa","Sab","Sb","Sbc","Sc","Scd","Sd","Sdm","I","BCD");
@morph_name=("E","E","E","E","E","E","E","E","S0","S0a","Sa","Sab","Sb","Sbc","Sc","Scd","Sd","Sdm","I","BCD");
@bar_name=("A","AB","B");



#
# MaNGA
#
$N_PHOT=0;
$phot_file="get_mag_cubes_v2_2_0_cen.csv";
open(FH,"<$phot_file");
while($line=<FH>) {
    chop($line);
    if ($line !~ "#") {
	@data=split(",",$line);
	$name_now=$data[0];
	$PHOTOMETRY{$name_now}=$line;
	$MORPH{$name_now}="none";
	$morph{$name_now}=-1;
	$bar{$name_now}=-1;
	$N_PHOT++;
    }
}
print "## Cubes with photometry = $N_PHOT in MANGA\n";

#
# MaNGA, morphological classification
#
my $n_morph_MaNGA=0;
open(FH,"<clasificacion_manga_mpl4_mpl5.txt");
while($line=<FH>) {
    chop($line);
    if ($line !~ "#") {
	$n_morph_MaNGA++;
	my @data=split(" ",$line);
	my $name=$data[0];
	my $PHOT=$PHOTOMETRY{$name};
	my @phot_now=split(",",$PHOT);
	my $elip=int($phot_now[37]*10);
        my $line_new=$line;
	$line_new =~ s/$name//g;
#	$line_new =~ s///g;
	$line_new =~ s/\d//g;
	$line_new =~ s/\.//g;
	my @data_l=split(" ",$line_new);
	my $class1=$data_l[0];
#	print "$name|$class1\n";


#	my $class1=$data[4];
	$MORPH{$name}=$class1;
	$morph{$name}=-1;
#
# Presence of bars
#
#	print "#$name,$bar{$name}\n";

	if ($class1 =~ "S") {
	    if ($class1 =~ 'AB') { 	    
		$bar{$name} = 1; 
		$cut="AB";
		$class1 =~ s/$cut//g;
	    } else {
		if ($class1 =~ 'A') { 
		    $bar{$name} = 0; 
		    $cut="A";
		    $class1 =~ s/$cut//g;		
		} else {
		    if ($class1 =~ 'B') { 
			$bar{$name} = 2; 
			$cut="B";
			$class1 =~ s/$cut//g;		
		    } 
		}
	    }
	}

#
# Morphology
#

	if ($class1 =~ "BCD") {
	    $morph{$name}=19;
	}
#	if ($class1 =~ "edge") {
#	    $morph{$name}=16;
#	}
	if ($class1 =~ "S") {
	    $morph{$name}=13;
#	    if ($class1 =~ '0')  { $morph{$name}=8; }
	    if ($class1 =~ 'O')  { $morph{$name}=8; }
	    if ($class1 =~ 'a')  { $morph{$name}=10; }
	    if ($class1 =~ 'b')  { $morph{$name}=12; }
	    if ($class1 =~ 'c')  { $morph{$name}=14; }
	    if ($class1 =~ 'd')  { $morph{$name}=16; }
	    if ($class1 =~ 'I')  { $morph{$name}=18; }
	    if ($class1 =~ 'm')  { $morph{$name}=18; }
#	    if ($class1 =~ '0a') { $morph{$name}=9; }
	    if ($class1 =~ 'Oa') { $morph{$name}=9; }
	    if ($class1 =~ 'ab') { $morph{$name}=11; }
	    if ($class1 =~ 'bc') { $morph{$name}=13; }
	    if ($class1 =~ 'cd') { $morph{$name}=15; }
	    if ($class1 =~ 'dm') { $morph{$name}=17; }	    
	}
	if ($class1 =~ "I") {
	    $morph{$name}=18;
	}

	if ($class1 =~ "E") {
	    if ($elip>7) {
		$elip=7;
	    }
	    $morph{$name}=7;#$elip;
	}

	if ($class1 =~ "Ecompact") {
	    if ($elip>7) {
		$elip=7;
	    }
	    $morph{$name}=7;#$elip;
	}


#	if ($morph{$name}==0) {
#	    print "#$name,$MORPH{$name},$bar{$name},$morph{$name}\n"; 
#	}
    }
}

print "## Cubes with morphology = $n_morph_MaNGA in MANGA\n";

#######################################################
# CALIFA
######################################################
$N_PHOT=0;
#$phot_file="/home/sanchez/Documents/CALIFA/DR3/get_mag_cubes_v2.2.csv";
$phot_file="/home/sanchez/Documents/CALIFA/DR4/get_mag_cubes_v2.2.csv";
open(FH,"<$phot_file");
while($line=<FH>) {
    chop($line);
    if ($line !~ "#") {
	@data=split(",",$line);
	$name_now=$data[0];
	$C{$name_now}=$data[43];
	$e_C{$name_now}=$data[44];
	$Mabs_R{$name_now}=$data[29];
	$e_Mabs_R{$name_now}=$data[30];
	$BR{$name_now}=$data[54];
	$e_BR{$name_now}=$data[55];
	$PHOTOMETRY{$name_now}=$line;
	$MORPH{$name_now}="none";
	$morph{$name_now}=-1;
	$bar{$name_now}=-1;
	$N_PHOT++;
    }
}
print "## Cubes with photometry = $N_PHOT CALIFA\n";

$file="/home/sanchez/Documents/CALIFA/DR3/CALIFA_basic_joint.csv";
open(FH,"<$file");
while($line=<FH>) {
    chop($line);
    if ($line !~ "#") {
        @data=split(/\,/,$line);
        my $id=int($data[0]*1.0);
        $name_now=$data[1];
        $NAME_ID{$id}=$name_now;
    }
}
close(FH);

#
# Need to be updated!
#
open(FH,"</home/sanchez/Documents/CALIFA/DR3/CALIFA_3_joint_classnum.csv");
$n_morph=0;
while($line=<FH>) {
    chop($line);
    if ($line !~ "#") {
	$n_morph++;
	$line =~ s/ //g;
	my @data=split(/\,/,$line);
	my $name=$data[1];
	my $PHOT=$PHOTOMETRY{$name};
	my @phot_now=split(",",$PHOT);
	my $elip=int($phot_now[37]*10);
        my $line_new=$line;
	$line_new =~ s/$name//g;
	$line_new =~ s/\d//g;
	$line_new =~ s/\.//g;
	my @data_l=split(" ",$line_new);
	my $class1=$data_l[0];
	$morph{$name}=$data[5];
	$bar{$name}=$data[6];
	$MORPH{$name}=$morph_name[$data[5]];
    }
}
close(FH);
print "## $n_morph galaxies with morphology in CALIFA\n";


################################################################
# SAMI
################################################################


$N_PHOT_sami=0;
$phot_file="tables/get_mag_cubes_SAMI.csv";
open(FH,"<$phot_file");
while($line=<FH>) {
    chop($line);
    if ($line !~ "#") {
	@data=split(",",$line);
	$name_now=$data[0];
	$C{$name_now}=$data[43];
	$e_C{$name_now}=$data[44];
	$Mabs_R{$name_now}=$data[29];
	$e_Mabs_R{$name_now}=$data[30];
	$BR{$name_now}=$data[54];
	$e_BR{$name_now}=$data[55];
	$PHOTOMETRY{$name_now}=$line;
	$MORPH{$name_now}="none";
	$morph{$name_now}=-1;
	$bar{$name_now}=-1;
	$N_PHOT_sami++;
    }
}
print "## Cubes with photometry = $N_PHOT_sami SAMI\n";

$n_morph_SAMI=0;
$file="tables/SAMI_Morph_name.csv";
open(FH,"<$file");
while($line=<FH>) {
    chop($line);
    if ($line !~ "#") {
        @data=split(/\,/,$line);
        $name_now=$data[0];
        $morph{$name_now}=$data[1];
	if ($data[1]>-1) {
	    $n_morph_SAMI++;
	}
    }
}
close(FH);

print "## $n_morph galaxies with morphology in SAMI\n";


###########################################################################
# MUSE
###########################################################################


$N_PHOT_MUSE=0;
#$phot_file="/home/sanchez/Documents/CALIFA/DR3/get_mag_cubes_v2.2.csv";
$phot_file="tables/get_mag_cubes_MUSE.csv";
open(FH,"<$phot_file");
while($line=<FH>) {
    chop($line);
    if ($line !~ "#") {
	@data=split(",",$line);
	$name_now=$data[0];
	$C{$name_now}=$data[43];
	$e_C{$name_now}=$data[44];
	$Mabs_R{$name_now}=$data[29];
	$e_Mabs_R{$name_now}=$data[30];
	$BR{$name_now}=$data[54];
	$e_BR{$name_now}=$data[55];
	$PHOTOMETRY{$name_now}=$line;
	$MORPH{$name_now}="none";
	$morph{$name_now}=-1;
	$bar{$name_now}=-1;
	$N_PHOT_MUSE++;
    }
}
print "## Cubes with photometry = $N_PHOT_MUSE MUSE\n";


#
# Need to be updated!
#
open(FH,"<tables/MUSE_morphology.csv");
$n_morph_MUSE=0;
while($line=<FH>) {
    chop($line);
    if ($line !~ "#") {
	$line =~ s/ //g;
	my @data=split(/\,/,$line);
	my $name=$data[1];
	my $morph_now=$data[4];
	my $bar_now=$data[5];
	if ($morph_now ne "NO") {
	    $morph{$name}=-1;
	    $MORPH{$name}="NO";
#$morph_name[$data[5]];
	    
	    for (my $i=0;$i<$#morph_name+1;$i++) {
		if ($morph_now eq $morph_name[$i]) {
		    $morph{$name}=$i;
		    $MORPH{$name}=$morph_name[$i];
		}
	    }
	    if ($morph{$name}>-1) {
		if ($morph{$name}>7) {
		    if ($bar_now==0) {
			$bar{$name}="A";
		    } else {
			$bar{$name}="B";
		    }
		} else {
		    $bar{$name}="";
		}

		$n_morph_MUSE++;
#		print "$name,$morph{$name},$MORPH{$name},$bar{$name}\n";
	    }
	}
    }
}
close(FH);
print "## $n_morph_MUSE galaxies with morphology in MUSE\n";
#exit;






$n_morph=$n_morph+$n_morph_MaNGA+$n_morph_SAMI+$n_morph_MUSE;
print "## $n_morph galaxies with morphology in total\n";



#
# We glue all morphologies
#

for ($i=0;$i<$n;$i++) {
    $name_now=$name[$i];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }
    $A_MORPH[$i]=$morph{$name_now};#$data[$n_Mass];
}
##################################################################
# ENDReading morphological tables!
##################################################################
# Output file
print "N = $n\n";

#########################################################################################
###
###  Morph-Re (4c)
###
#########################################################################################
#$DEV=$dev;
########

$f=0.31;
$WIDTH_LINE=9;
$SIZE_MARK=2.1;
#$color_mark=8;
#
$color_mark=3;
#$color_mark=9;
#$color_mark=11;
#$color_mark=11;
$hist_c=60;
#$s_mark=6;
#$s_mark=14;
#$s_mark=18;
#
$s_mark=12;
#$s_mark=14;
$F_COR=2;

$SN_cut=8; # SN_peak intensity of Broad Ha


$c_min=-1;
$c_max=2.5;

my $pdl_X;
my $pdl_Y;
my $pdl_C;
my @xx;
my @yy;
my @cc; my @NAME;
$x_min=5.5; $x_max=20.5; 
#$y_min=0; $y_max=6.5;
$y_min=0; $y_max=25;
$label1="Morphological Type";
$label2="Re/kpc";
$dev="Morph_Re_joint.ps/CPS";
for ($i=0;$i<$n;$i++) {
    $name_now=$name[$i];#=$data[0];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }
    $xx[$i]=$morph{$name_now};#$data[$n_Mass];
    $yy[$i]=$data[$n_Re];
    $cc[$i]=log10($data[$n_EW_Ha_cen]);
   # print "$xx[$i],$yy[$i],$cc[$i]\n";
}

pgbegin(0,$dev,1,1);
pgsfs(1.2);
pgscf(2);             # Set character font
pgslw(2);             # Set line width
pgsch(1.4);           # Set character height
#pgsvp(0.1,0.85,0.15,0.85);
#pgsvp(0.15,0.85,0.15,0.9);
$f=0.31;
pgsvp($f,0.9,$f,0.95);
pgswin($x_min,$x_max,$y_min,$y_max);
pgbox("SBCR",0,0,"SBC",0,0);
#pglabel("$label1","$label2","");
pgscir(50,100);
CALIFA_cmap_vel();

pgsch(2.5);
$k=0;



for ($i=0;$i<$n;$i++) {
    $X=$xx[$i];
    $Y=$yy[$i];
    $color[$i]=$cc[$i];
    $name_now=$name[$i];
    if (($X>$x_min)&&($X<$x_max)&&($Y>$y_min)&&($Y<$y_max)&&($color[$i]>$c_min)&&($color[$i]<$c_max)) {
	if ($c_min!=$c_max) {
	    $color_now=50+int(48*($color[$i]-$c_min)/($c_max-$c_min));
	} else {
	    if ($color[$i]==$c_min) {
		$color_now=1;
	    } else {
		$color_now=0;
	    }
	}

	pgsch(1.1);
    pgsci($color_now);     
    pgpoint(1,[$X],[$Y],17);
    pgsci(1);
	pgsch(1.1);
	pgsci(1);
	pgslw(2);
	pgslw(1);
    }
}

$k1=0;
$k2=0;
$k=0;
my @X_TYPE;
my @Y_TYPE;
my @SUM_TYPE;
for ($i=0;$i<$n;$i++) {
    $X=$xx[$i];
    $Y=$yy[$i];
    $color[$i]=$cc[$i];
    $name_now=$name[$i];
    if (($X>$x_min)&&($X<$x_max)&&($Y>$y_min)&&($Y<$y_max)) {
	$TYPE=$xx[$i];
	$Y_TYPE[$TYPE]=$Y_TYPE[$TYPE]+$Y;
	$X_TYPE[$TYPE]=$X_TYPE[$TYPE]+$X;
	$SUM_TYPE[$TYPE]=$SUM_TYPE[$TYPE]+1;
	$k++;
	pgsci($color_mark);
	if ($a_TYPE_BROAD{$name_now}==1) {
	    $xx1[$k1]=$X;
	    $yy1[$k1]=$Y;
	    $k1++;
	    pgsci(1);
	}
	if (($a_TYPE{$name_now}==2)||($a_TYPE{$name_now}==3)) {
	#    if ($morph{$name_now}==3) {
	#	print "#$X,$Y,$morph{$name_now}\n"; <stdin>;
	#    }
	    if ($a_TYPE_BROAD{$name_now}!=1) {
		$xx2[$k2]=$X;
		$yy2[$k2]=$Y;
		$k2++;
	    }
	    pgsch($SIZE_MARK);
	    pgslw($WIDTH_LINE);
	    pgpoint(1,[$X],[$Y],$s_mark);
	    pgslw(2);
	}
    }
}

pgslw(2);
pgsci(1);
pgsch(2.4);
pgwedg("RI",0.0,3,$c_min,$c_max,"$label3");
pgsci(1);

$k=0;
my @Y_MEAN;
for ($i=0;$i<21;$i++) {
    if ($SUM_TYPE[$i]!=0) {
	$Y_TYPE_P[$k]=$Y_TYPE[$i]/$SUM_TYPE[$i];
	$X_TYPE_P[$k]=$X_TYPE[$i]/$SUM_TYPE[$i];
	$Y_MEAN{$X_TYPE_P[$k]}=$Y_TYPE_P[$k];
	$k++;
    }
}
################################################################################
# Above and below the line
#
print "##############################################################################\n";
$n_UP=0;
$n_DOWN=0;
$n_ALL=0;
for ($i=0;$i<$n;$i++) {
    $X=$xx[$i];
    $Y=$yy[$i];
    if (($X>$x_min)&&($X<$x_max)&&($Y>$y_min)&&($Y<$y_max)) {
	if ($Y>=$Y_MEAN{$X}) {
	    $n_UP++; 
	} else {
	    $n_DOWN++;
	} 
	$n_ALL++;
   }

}
$f_UP=apr($n_UP/$n_ALL*100);
$f_DOWN=apr($n_DOWN/$n_ALL*100);
print "# ALL = $label1 vs $label2 = $f_UP / $f_DOWN\n";
$n_UP=0;
$n_DOWN=0;
$n_ALL=0;
for ($i=0;$i<$k2;$i++) {
    $X=$xx2[$i];
    $Y=$yy2[$i];
    if (($X>$x_min)&&($X<$x_max)&&($Y>$y_min)&&($Y<$y_max)) {
    if ($Y>=$Y_MEAN{$X}) {
      $n_UP++; 
    } else {
      $n_DOWN++;
   }
    $n_ALL++;
}

}

if ($n_ALL!=0) {
    $f_UP=apr($n_UP/$n_ALL*100);
    $f_DOWN=apr($n_DOWN/$n_ALL*100);
    print "# AGN-II $label1 vs $label2 = $f_UP / $f_DOWN\n";
}
$n_UP=0;
$n_DOWN=0;
$n_ALL=0;
for ($i=0;$i<$k1;$i++) {
    $X=$xx1[$i];
    $Y=$yy1[$i];
    if (($X>$x_min)&&($X<$x_max)&&($Y>$y_min)&&($Y<$y_max)) {
	if ($Y>=$Y_MEAN{$X}) {
	    $n_UP++; 
	} else {
	    $n_DOWN++;
	}
	$n_ALL++;
}

}
if ($n_ALL!=0) {
$f_UP=apr($n_UP/$n_ALL*100);
$f_DOWN=apr($n_DOWN/$n_ALL*100);
print "# AGN-I $label1 vs $label2 = $f_UP / $f_DOWN\n";
}
print "##############################################################################\n";
pgsls(2);
pgsci(1);
pgslw(5);
pgline($k,\@X_TYPE_P,\@Y_TYPE_P);
pgslw(2);
pgsls(1);


#
# Y-histogram
#
$NB=20; $f_scale=0.35;
pgsvp(0.15,$f,$f,0.95);
pgsch(1.3);
pgswin(0,$f_scale,$y_min,$y_max);
pgsch(1.5);
pglabel("","$label2","");
my @XY; my @YY;
@XX=hist_y_norm($y_min,$y_max,$NB,@yy);
@YY=hist_x($y_min,$y_max,$NB);           
pgsci($hist_c);
for ($j=$#XX;$j>-1;$j--) {
    my $D=($y_max-$y_min)/(2*$NB);    
    pgsch(1.25);                                                                                                             
    pgsfs(1);
    pgrect(0,$XX[$j],$YY[$j]-$D,$YY[$j]+$D);
    pgsfs(2);              
    pgrect(0,$XX[$j],$YY[$j]-$D,$YY[$j]+$D);
}

#Type 2
my @XY; my @YY;
@XX=hist_y_norm($y_min,$y_max,$NB,@yy2);
@YY=hist_x($y_min,$y_max,$NB);           
pgsci($color_mark);
for ($j=$#XX;$j>-1;$j--) {
    my $D=($y_max-$y_min)/(2*$NB);    
    pgsch(1.25);                                                                                                             
    pgsfs(3);
    pgrect(0,$XX[$j],$YY[$j]-$D,$YY[$j]+$D);
    pgsfs(2);              
    pgrect(0,$XX[$j],$YY[$j]-$D,$YY[$j]+$D);
}


#Type 1
my @XY; my @YY;
@XX=hist_y_norm($y_min,$y_max,$NB,@yy1);
@YY=hist_x($y_min,$y_max,$NB);           
pgsci(1);
for ($j=$#XX;$j>-1;$j--) {
    my $D=($y_max-$y_min)/(2*$NB);    
    pgsch(1.25);                                                                                                             
    pgsfs(2);
    pgrect(0,$XX[$j],$YY[$j]-$D,$YY[$j]+$D);
    pgsfs(2);              
    pgrect(0,$XX[$j],$YY[$j]-$D,$YY[$j]+$D);
}
pgsci(1); pgbox("SBCRN",0,0,"SBCN",0,0);

#
# X-histogram
#
$NB=15; $f_scale=0.45;#*$n;
pgsvp($f,0.9,0.15,$f);
pgsch(1.3);
pgswin($x_min,$x_max,0,$f_scale);
pgsch(1.5);
pgsci(1);
#pglabel("","$label2","");
# ALL
pgsci($hist_c);
my @XY; my @YY;
@XX=hist_x($x_min,$x_max,$NB);           
@YY=hist_y_norm($x_min,$x_max,$NB,@xx);
for ($j=$#XX;$j>-1;$j--) {
    my $D=($x_max-$x_min)/(2*$NB);    
    pgsch(1.25);        
    pgsfs(1);              
    pgrect($XX[$j]-$D,$XX[$j]+$D,0,$YY[$j]);
    pgsfs(2);              
    pgrect($XX[$j]-$D,$XX[$j]+$D,0,$YY[$j]);                                                                                                    
    
}
# Type2
pgsci($color_mark);
my @XY; my @YY;
@XX=hist_x($x_min,$x_max,$NB);           
@YY=hist_y_norm($x_min,$x_max,$NB,@xx2);
for ($j=$#XX;$j>-1;$j--) {
    my $D=($x_max-$x_min)/(2*$NB);    
    pgsch(1.25);        
    pgsfs(3);              
    pgrect($XX[$j]-$D,$XX[$j]+$D,0,$YY[$j]);
    pgsfs(2);              
    pgrect($XX[$j]-$D,$XX[$j]+$D,0,$YY[$j]);                                                                                                    
    
}
pgsci(1); pgbox("SBCR",0,0,"SBCMV",0,0);

# Type1
pgsci(1);
my @XY; my @YY;
@XX=hist_x($x_min,$x_max,$NB);           
@YY=hist_y_norm($x_min,$x_max,$NB,@xx1);
for ($j=$#XX;$j>-1;$j--) {
    my $D=($x_max-$x_min)/(2*$NB);    
    pgsch(1.25);        
    pgsfs(2);              
    pgrect($XX[$j]-$D,$XX[$j]+$D,0,$YY[$j]);
    pgsfs(2);              
    pgrect($XX[$j]-$D,$XX[$j]+$D,0,$YY[$j]);                                                                                                    
    
}
pgsci(1); pgbox("SBCR",0,0,"SBCMV",0,0);

pgsch(1.5); # LABEL
for ($i=7;$i<21;$i++) {
    pgptxt($i-0.25,-0.1,-90,0.25,$morph_name[$i]);
}
pglabel("$label1","","");

pgclose;
pgend;

#######################################################################






#########################################################################
# START: BPT diagram GNUPLOT. Just a test!
#########################################################################
if ($gnuplot==1) {

my @x;
my @x_2;
my @x_3;
my @e_x;
my @e_x_2;
my @e_x_3;
my @y;
my @e_y;
my @color;
$i=0;


for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    
    $nc1=$n_NII_Ha; # NII]/Ha
    $nc1_2=$n_SII_Ha; # SII]/Ha
    $nc1_3=$n_OI_Ha; # OII]/Hb
    $nc2=$n_OIII_Hb; # OIII]/Hb
    $ncolor=$n_EW_Ha_cen; # EW(Ha)    
#print "(($data[$nc1] ne 'BAD')&&($data[$nc1_2] ne 'BAD')&&($data[$nc1_3] ne 'BAD')&&($data[$nc2] ne 'BAD')&&($data[$ncolor] ne 'BAD'))\n";
#    if (($data[$ncolor] eq "BAD")||($data[$ncolor] eq "NaN")) {
#        $data[$ncolor]=1e12;    
#    }

if (($data[$nc1] ne "BAD")&&($data[$nc1_2] ne "BAD")&&($data[$nc1_3] ne "BAD")&&($data[$nc2] ne "BAD")&&($data[$ncolor] ne "BAD")&&($data[$nc1+1] ne "BAD")&&($data[$nc1_2+1] ne "BAD")&&($data[$nc1_3+1] ne "BAD")) {
        $x[$i]=$data[$nc1];
        $x_2[$i]=$data[$nc1_2];
        $x_3[$i]=$data[$nc1_3];
        $y[$i]=$data[$nc2];
        $e_x[$i]=$data[$nc1+1];
        $e_x_2[$i]=$data[$nc1_2+1];
        $e_x_3[$i]=$data[$nc1_3+1];
        $e_y[$i]=$data[$nc2+1];
        $color[$i]=log10(abs($data[$ncolor]));
 #   print "$i,$x[$i],$x_2[$i],$x_3[$i],$y[$i],$color[$i],$ncolor\n";
    if (($color[$i]>-0.5)&&($e_x[$i]<3)) {
    $i++;
    }
}
        
}
print "I=$i\n";


my $pdl_x=pdl(@x);
my $pdl_x_2=pdl(@x_2);
my $pdl_x_3=pdl(@x_3);
my $pdl_y=pdl(@y);
my $pdl_ex=pdl(@e_x);
my $pdl_ex_2=pdl(@e_x_2);
my $pdl_ex_3=pdl(@e_x_3);
my $pdl_ey=pdl(@e_y);
my $pdl_color=pdl(@color);
$pdl_x->inplace->setbadtoval(-12);
$pdl_x_2->inplace->setbadtoval(-12);
$pdl_x_3->inplace->setbadtoval(-12);

@dims=$pdl_x->dims();
#print "DIM=@dims,$#x\n";

$pdl_y->inplace->setbadtoval(-12);
$pdl_color->inplace->setbadtoval(-3);
$pdl_size=0.02+0.0*sqrt($pdl_ex**2+$pdl_ey**2);
$pdl_size_2=0.02+0.0*sqrt($pdl_ex_2**2+$pdl_ey**2);
$pdl_size_3=0.02+0.0*sqrt($pdl_ex_3**2+$pdl_ey**2);

$pdl_cut_x=-3+0.02*pdl(0..300);
$pdl_cut_y=-0.7+0.2-3.67*$pdl_cut_x;
$pdl_cut_y2=-1.7+0.5-3.67*$pdl_cut_x;
$pdl_cut_y3=0.61/($pdl_cut_x-0.05)+1.3;
$pdl_cut_y4=0.61/($pdl_cut_x-0.47)+1.19;
$pdl_cut_y3->inplace->clip(-2,1.1);
$pdl_cut_y4->inplace->clip(-2,1.1);
$pdl_cut_y3->inplace->setvaltobad(1.1);
$pdl_cut_y4->inplace->setvaltobad(1.1);
$pdl_cut_y_SII=0.61/($pdl_cut_x-0.3)+1.3;
$pdl_cut_y_SII=0.61/($pdl_cut_x-0.3)+1.3;
$pdl_cut_y_SII_AGNs=1.89*($pdl_cut_x)+0.76;
$pdl_cut_y_OI=0.73/(($pdl_cut_x+0.59))+1.33;#+1.10;
$pdl_cut_y_OI_AGNs=1.18*($pdl_cut_x)+1.30;
$pdl_cut_y_OIII_AGNs=1.14*($pdl_cut_x)+0.36;
#$cut_y[$i]=1.18*($cut_x[$i])+1.30;

#print "$pdl_cut_y3\n";

#print "$pdl_y";
$label1_1='log([NII]/H{/Symbol a})';
$label1_2='log([SII]/H{/Symbol a})';
$label1_3='log([OI]/H{/Symbol a})';
$label2='log([OIII]/H{/Symbol b})';
$label_cb='log|EW(H{/Symbol a})|';
#$x_min1=-1.75;
#$x_max1=0.75;
#$y_min1=-1.6;
#$y_max1=1.6;
$x_min1=-1.75;
$x_max1=0.75;
$y_min1=-1.6;
$y_max1=1.6;
#$plot_file="BPT.png";
#$w = gpwin(pngcairo, output=>$plot_file, size=>[11,3.5,'in'],font=>'Helvetica,15', enhanced=>1);

$plot_file="BPT.png";
$w = gpwin(pngcairo, output=>$plot_file, size=>[10,4,'in'],font=>'Helvetica,15', enhanced=>1);
$w->multiplot(layout=>[3,1,"columnsfirst"]);
$w->option(topcmds=>"set loadpath '/home/sanchez/sda1/gnuplot-palettes/'
");
$w->option(title=>"", xr=>[$x_min1,$x_max1],yr=>[$y_min1,$y_max1],  xlab=>$label1_1,
ylab=>$label2,
           style=>"fill transparent solid 0.5 noborder", {palette=>"negative ".palette('ExtendedBlackBody')});  
$w->option(extracmds=>"
#load '/home/sanchez/sda1/gnuplot-palettes/spectral.pal'
set cbrange [-0.9:2.2]
unset colorbox
set lmargin at screen 0.09; set rmargin at screen 0.36
#show style line
#unset termoption dash
#set style func linespoints
#set for [i=1:5] linetype i dt i
#
# define line styles using explicit rgbcolor names
#
set style line 1 lt 1 lc rgb 'black' lw 3
set style line 2 lt 2 lc rgb 'black' lw 3
set style line 3 lt 2 lc rgb 'black'' lw 3
set label 1 'Center' at -1.5,1.3
");
#$pdl_cut_y_OIII_AGNs=1.14*($pdl_cut_x)+0.36;
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
$w->plot(with=>"circles", lc=>"palette", $pdl_x, $pdl_y, $pdl_size, $pdl_color,
#        with=>"linespoints", lt=>1, lw=>2, lc=>'black',  $pdl_cut_x,$pdl_cut_y3,
        with=>"lines", lt=>1, dt=>1, lw=>3, lc=>'black', $pdl_cut_x,$pdl_cut_y4,
        with=>"lines", lt=>3, dt=>2, lw=>3, lc=>'grey30', $pdl_cut_x,$pdl_cut_y3,
        with=>"lines", lt=>2, dt=>2, lw=>3, lc=>'black', $pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);


$w->option(title=>"", xr=>[$x_min1+0.4,$x_max1],yr=>[$y_min1,$y_max1],  xlab=>$label1_2,
ylab=>$label2,
           style=>"fill transparent solid 0.5 noborder", {palette=>"negative ".palette('ExtendedBlackBody')});
$w->option(extracmds=>"
#load '/home/sanchez/sda1/gnuplot-palettes/spectral.pal'
unset label
unset ylabel
unset ytic
set lmargin at screen 0.36; set rmargin at screen 0.63
");

$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
$w->plot(with=>"circles", lc=>"palette", $pdl_x_2, $pdl_y, $pdl_size_2, $pdl_color,
with=>"lines", lt=>1, dt=>1, lw=>3, lc=>'black', $pdl_cut_x,$pdl_cut_y_SII,
with=>"lines", lt=>2, dt=>2, lw=>3, lc=>'black',  $pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);

$w->option(title=>"", xr=>[$x_min1-1.1,$x_max1-0.2],yr=>[$y_min1,$y_max1],  xlab=>$label1_3,
ylab=>$label2, cblab=>$label_cb,
           style=>"fill transparent solid 0.5 noborder", {palette=>"negative ".palette('ExtendedBlackBody')});  
$w->option(extracmds=>"
#load '/home/sanchez/sda1/gnuplot-palettes/plasma.pal'
set colorbox
unset label
unset ylabel
unset ytic
set lmargin at screen 0.63; set rmargin at screen 0.9
");
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
$pdl_x_3->inplace->setvaltobad(0);
$w->plot(with=>"circles", lc=>"palette", $pdl_x_3, $pdl_y, $pdl_size_3, $pdl_color,
with=>"lines", lt=>1, dt=>1, lw=>3, lc=>'black', $pdl_cut_x,$pdl_cut_y_OI,
with=>"lines", lt=>2, dt=>2, lw=>3, lc=>'black',  $pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);

$w->end_multi();

$w->close();
#########################################################################
# END: BPT diagram GNUPLOT
#########################################################################
}

#########################################################################
# BPT diagram PLPLOT
#########################################################################
# Output file
print "N = $n\n";

open(OUT,">AGNs_candidates.csv");
print OUT "# AUTHOR: S.F. Sanchez\n";
print OUT "# SOURCE: Pipe3D COMBINED analysis\n";
print OUT "# DATE: 2018-10-12\n";
print OUT "# VERSION: NEW\n";
print OUT "# COLAPRV:  S.F.Sanchez\n";
print OUT "# PUBAPRV:  \n";
print OUT "# COLUMN1: CUBEID, string,  , CUBE name of the cube\n";
print OUT "# COLUMN2: objra, float, degree  , RA of the object \n";
print OUT "# COLUMN3: objdec, float, degree  , DEC of the object \n";
print OUT "# COLUMN4: redshift, float,   , redshift derived by Pipe3D form the center of the galaxy\n";
print OUT "# COLUMN5: log_NII_Ha_cen, float, , logarithm of the [NII]6583/Halpha line ratio in the central 2.5 arcsec\n";
print OUT "# COLUMN6: e_log_NII_Ha_cen, float, , error in the logarithm of the [NII]6583/Halpha line ratio \n";
print OUT "# COLUMN7: log_OIII_Hb_cen, float, , logarithm of the [OIII]5007/Hbeta line ratio in the central 2.5 arcsec\n";
print OUT "# COLUMN8: e_log_OIII_Hb_cen, float, , error in the logarithm of the [OIII]5007/Hbeta line ratio\n";
print OUT "# COLUMN9: log_SII_Ha_cen, float, , logarithm of the [SII]6717+6731/Halpha line ratio in the centra\n";
print OUT "# COLUMN10: e_log_SII_Ha_cen, float, , error in the logarithm of the [SII]6717/Halpha line ratio\n";
print OUT "# COLUMN11: log_OI_Ha_cen, float, , logarithm of the [OI]6301/Halpha line ratio in the central 2.5arcsec\n";
print OUT "# COLUMN12: e_log_OI_Ha_cen, float, , error in the logarithm of the [OI]6301/Halpha line ratio \n";
print OUT "# COLUMN13: EW_Ha_cen, float, , EW of Halpha in the central 2.5arcsec/aperture\n";
print OUT "# COLUMN14: e_EW_Ha_cen, float, , error of the EW of Halpha in the central 2.5arcsec/aperture\n";
print OUT "# COLUMN15: sn_Ha_broad, float, , Signal-to-noise of the flux intensity of the broad component of Ha\n";
print OUT "# COLUMN16: agn_type, int,  , Type of AGN\n";
my @x;
my @x_2;
my @x_3;
my @e_x;
my @e_x_2;
my @e_x_3;
my @y;
my @e_y;
my @color;
my @a_morph;
my @Mass;
$i=0;
$nAGNs_OIII_NII=0;
$nAGNs_OIII_SII=0;
$nAGNs_OIII_OII=0;
$nAGNs_OIII_NII_EW=0;
$nAGNs_OIII_SII_EW=0;
$nAGNs_OIII_OII_EW=0;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    
    $nc1=$n_NII_Ha; # NII]/Ha
    $nc1_2=$n_SII_Ha; # SII]/Ha
    $nc1_3=$n_OI_Ha; # OII]/Hb
    $nc2=$n_OIII_Hb; # OIII]/Hb
    $ncolor=$n_EW_Ha_cen; # EW(Ha)    
    $TYPE=0;
if (($data[$nc1] ne "BAD")&&($data[$nc1_2] ne "BAD")&&($data[$nc1_3] ne "BAD")&&($data[$nc2] ne "BAD")&&($data[$ncolor] ne "BAD")&&($data[$nc1+1] ne "BAD")&&($data[$nc1_2+1] ne "BAD")&&($data[$nc1_3+1] ne "BAD")) {
        $x[$i]=$data[$nc1];
        $x_2[$i]=$data[$nc1_2];
        $x_3[$i]=$data[$nc1_3];
        $y[$i]=$data[$nc2];
        $e_x[$i]=$data[$nc1+1];
        $e_x_2[$i]=$data[$nc1_2+1];
        $e_x_3[$i]=$data[$nc1_3+1];
        $e_y[$i]=$data[$nc2+1];
        $color[$i]=log10(abs($data[$ncolor]));
	$a_morph[$i]=$A_MORPH[$j];
	$Mass[$i]=$data[$n_Mass];
    if (($color[$i]>-0.5)&&($e_x[$i]<3)) {
	#
	# AGN classification
	#
	my $cut_y4=0.61/($x[$i]-0.11*2-0.47)+1.19-2*0.085; 
	my $cut_OIII_by_SII=0.61/($x_2[$i]-0.09*2-0.3)+1.3-2*0.085;
	my $cut_OIII_by_OII=0.73/(($x_3[$i]+0.59))+1.33;#-2*0.085;#+1.10;
	$BUG=1;
	if (($x[$i]>-1)&&($x[$i]!=0)&&($y[$i]!=0)) {
	    if ($y[$i]>$cut_y4) {
		$nAGNs_OIII_NII++;
		if (abs($data[$ncolor])>3*$BUG) {
		    $nAGNs_OIII_NII_EW++;
		}		    
		if ($y[$i]>$cut_OIII_by_SII) {
		    $nAGNs_OIII_SII++;
		    if (abs($data[$ncolor])>3*$BUG) {
			$nAGNs_OIII_SII_EW++;
		    }		    
		    if ($y[$i]>$cut_OIII_by_OII) {
			$nAGNs_OIII_OII++;
			if (abs($data[$ncolor])>3*$BUG) {
			    $TYPE=2;
			    if (abs($data[$ncolor])>6*$BUG) {
				$TYPE=3;
				$nAGNs_strong++;
				if (abs($data[$ncolor])>10*$BUG) {
				    $nAGNs_very_strong++;
				}
			    }
			    $nAGNs++;
			}
		    }
		}
	    }
	}
	if ((abs($data[$ncolor])<=3)) {
	    $TYPE=4;
	    $nPOST_SF++;
	}
	if (($x[$i]!=0)&&($y[$i]!=0)&&($y[$i]>$cut_y4)&&(abs($data[$ncolor])<=3)) {
	    $nPOST++;
	}
	
	if (($x[$i]!=0)&&($y[$i]!=0)&&($y[$i]<=$cut_y4)&&(abs($data[$ncolor])>3*$BUG)) {
	    if ((abs($data[$ncolor])>6*$BUG)) {
		$TYPE=1;
		$nSF_strong++;
	    } else {
		$TYPE=6;
	    }
	    $nSF++;
	}

	if ((($SN{$name_now}>$SN_cut)&&(($TYPE==2)||($TYPE==3)))||($BROAD_EYE{$name_now}==1)) {
	    $a_TYPE_BROAD{$name_now}=1;
	    $n_type_I++;
	    if (($SN{$name_now}>$SN_cut)&&(($TYPE==2)||($TYPE==3))) {
		$n_type_I_PURE++;
	    } else {
		print "# NON.PURE = $name_now\n";		    
	    }
	}
	print OUT "$data[0],$x[$i],$y[$i],$data[$ncolor],$TYPE,$a_TYPE_BROAD{$name_now}\n";

    $i++;
    } else {
	$n_no_gas++;
	$TYPE=-1;
    }
	$a_TYPE{$name_now}=$TYPE;

}
        
}

print "#N.TOTAL = $n, WITH DATA $i\n";
print "#N.NO GAS = $n_no_gas\n";
print "#N.AGNs [OIII] vs. [NII] candidates = $nAGNs_OIII_NII  EW>3 $nAGNs_OIII_NII_EW\n";
print "#N.AGNs [OIII] vs. [SII] candidates = $nAGNs_OIII_SII  EW>3 $nAGNs_OIII_SII_EW\n";
print "#N.AGNs [OIII] vs. [OI] candidates = $nAGNs_OIII_OII\n";
print "#N.AGNs candidates (EW>3*$BUG) = $nAGNs\n";
print "#N.AGNs strong (EW>6*$BUG)= $nAGNs_strong , Very strong = $nAGNs_very_strong\n";
print "#N.P-AGB = $nPOST_SF ,  y>Kewley => $nPOST\n";
print "#N.SF = $nSF , SF_string EW_Ha>6*$BUG $nSF_strong\n";
#print "#N.COL = $#data\n";
#print "I=$i\n";

close(OUT);

my $pdl_Morph=pdl(@a_morph);
my $pdl_Mass=pdl(@Mass);
my $pdl_x=pdl(@x);
my $pdl_x_2=pdl(@x_2);
my $pdl_x_3=pdl(@x_3);
my $pdl_y=pdl(@y);
my $pdl_ex=pdl(@e_x);
my $pdl_ex_2=pdl(@e_x_2);
my $pdl_ex_3=pdl(@e_x_3);
my $pdl_ey=pdl(@e_y);
my $pdl_color=pdl(@color);
$pdl_x->inplace->setbadtoval(-12);
$pdl_x_2->inplace->setbadtoval(-12);
$pdl_x_3->inplace->setbadtoval(-12);

@dims=$pdl_x->dims();
print "DIM=@dims,$#x\n";

$pdl_y->inplace->setbadtoval(-12);
$pdl_color->inplace->setbadtoval(-3);
$pdl_size=0.02+0.0*sqrt($pdl_ex**2+$pdl_ey**2);
$pdl_size_2=0.02+0.0*sqrt($pdl_ex_2**2+$pdl_ey**2);
$pdl_size_3=0.02+0.0*sqrt($pdl_ex_3**2+$pdl_ey**2);

$pdl_cut_x=-3+0.02*pdl(0..300);
$pdl_cut_y=-0.7+0.2-3.67*$pdl_cut_x;
$pdl_cut_y2=-1.7+0.5-3.67*$pdl_cut_x;
$pdl_cut_y3=0.61/($pdl_cut_x-0.05)+1.3;
$pdl_cut_y4=0.61/($pdl_cut_x-0.47)+1.19;
$pdl_cut_y3->inplace->clip(-2,1.1);
$pdl_cut_y4->inplace->clip(-2,1.1);
$pdl_cut_y3->inplace->setvaltobad(1.1);
$pdl_cut_y4->inplace->setvaltobad(1.1);
$pdl_cut_y_SII=0.61/($pdl_cut_x-0.3)+1.3;
$pdl_cut_y_SII=0.61/($pdl_cut_x-0.3)+1.3;
$pdl_cut_y_SII_AGNs=1.89*($pdl_cut_x)+0.76;
$pdl_cut_y_OI=0.73/(($pdl_cut_x+0.59))+1.33;#+1.10;
$pdl_cut_y_OI_AGNs=1.18*($pdl_cut_x)+1.30;
$pdl_cut_y_OIII_AGNs=1.14*($pdl_cut_x)+0.36;

$pdl_cut_y_SII->inplace->clip(-2,1.1);
$pdl_cut_y_OI->inplace->clip(-2,1.1);
$pdl_cut_y_SII->inplace->setvaltobad(1.1);
$pdl_cut_y_OI->inplace->setvaltobad(1.1);

#$cut_y[$i]=1.18*($cut_x[$i])+1.30;

#print "$pdl_cut_y3\n";

#print "$pdl_y";
$label1_1='log([NII]/H#ga';
$label1_2='log([SII]/H#ga)';
$label1_3='log([OI]/H#ga)';
$label2='log([OIII]/H#gb)';
$label_cb='log|EW(H#ga)|';

#$x_min1=-1.75;
#$x_max1=0.75;
#$y_min1=-1.6;
#$y_max1=1.6;

$x_min1=-1.39;
$x_max1=0.39;
$y_min1=-1.19;
$y_max1=1.19;

$plot_file="plBPT_den".$pldev_suf; 
$alpha=1.0;
$alpha0=1.0;

my @stats=stats($pdl_color);
my $zmin=$stats[3];
my $zmax=$stats[4];
$zmin=-0.49;
#$zmin=-1.49;
$zmax=2.65;
print "ALL $zmin,$zmax\n";

my ($pdl_Mass_SF,$pdl_x_SF,$pdl_y_SF,$pdl_x_2_SF,$pdl_x_3_SF,$pdl_color_SF)=where($pdl_Mass,$pdl_x,$pdl_y,$pdl_x_2,$pdl_x_3,$pdl_color,$pdl_color>1);
my ($pdl_Mass_RG,$pdl_x_RG,$pdl_y_RG,$pdl_x_2_RG,$pdl_x_3_RG,$pdl_color_RG)=where($pdl_Mass,$pdl_x,$pdl_y,$pdl_x_2,$pdl_x_3,$pdl_color,$pdl_color<0.47);
my ($pdl_Mass_tmp,$pdl_x_tmp,$pdl_y_tmp,$pdl_x_2_tmp,$pdl_x_3_tmp,$pdl_color_tmp)=where($pdl_Mass,$pdl_x,$pdl_y,$pdl_x_2,$pdl_x_3,$pdl_color,$pdl_color>=0.47);
my ($pdl_Mass_GV,$pdl_x_GV,$pdl_y_GV,$pdl_x_2_GV,$pdl_x_3_GV,$pdl_color_GV)=where($pdl_Mass_tmp,$pdl_x_tmp,$pdl_y_tmp,$pdl_x_2_tmp,$pdl_x_3_tmp,$pdl_color_tmp,$pdl_color_tmp<=1);


plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 800;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

#
# ALL
#
plscol0a(0,0,0,0,1);
plcol0(0);
#plvpor (0.13, 0.895, 0.10, 0.95);
plvpor (0.10, 0.365, 0.74, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
#plbox (1.0, 0.25, 1.0, 0.25,
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcnstv");
#pllab($label1_1,$label2,"");
$symbol=0;
#plscatter($pdl_x,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
my $NX=70;
my $NY=70;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x,$pdl_y,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(3.5);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
# BPT SII
plvpor(0.365, 0.630, 0.74, 0.95);
plwind ($x_min1+0.4,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
#pllab($label1_2,"","");
$symbol=0;
#plscatter($pdl_x_2,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_SII,my $pdl_fden_BPT_SII, my $pdl_levels_SII)=density_map_XY($pdl_x_2,$pdl_y,$pdl_color,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_SII,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1-0.4)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+0.4+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@levels=($pdl_levels_SII->at(10),$pdl_levels_SII->at(50),$pdl_levels_SII->at(95));
plcol0(0);
plwidth(3.5);
plcont ($pdl_den_BPT_SII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
plline($pdl_cut_x,$pdl_cut_y_SII);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);
pllsty(1);
plwidth(1);
# BPT OI
plvpor (0.630, 0.895, 0.74, 0.95);
plwind ($x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
#pllab($label1_3,"","");
$symbol=0;
$pdl_x_3->inplace->setvaltobad(0);
#plscatter($pdl_x_3,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_OI,my $pdl_fden_BPT_OI, my $pdl_levels_OI)=density_map_XY($pdl_x_3,$pdl_y,$pdl_color,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_OI,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1-0.2+1.1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1-1.1,0,$dy,$y_min1);
@levels=($pdl_levels_OI->at(10),$pdl_levels_OI->at(50),$pdl_levels_OI->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_OI, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
plline($pdl_cut_x,$pdl_cut_y_OI);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);
pllsty(1);
plwidth(1);

#
# RG
#
plscol0a(0,0,0,0,1);
plcol0(0);
#plvpor (0.13, 0.895, 0.10, 0.95);
plvpor (0.10, 0.365, 0.53, 0.74);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcnstv");
$symbol=0;
my ($pdl_den_BPT_NII,$pdl_fden_BPT_NII,$pdl_levels_NII)=density_map_XY($pdl_x_RG,$pdl_y_RG,$pdl_color_RG,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(3.5);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"<3#[0x212b]");
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
# BPT SII
plvpor(0.365, 0.630, 0.53, 0.74);
plwind ($x_min1+0.4,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
#pllab($label1_2,"","");
$symbol=0;
#plscatter($pdl_x_2,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_SII,my $pdl_fden_BPT_SII, my $pdl_levels_SII)=density_map_XY($pdl_x_2_RG,$pdl_y_RG,$pdl_color_RG,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_SII,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1-0.4)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
#@tr=($dx,0,$x_min1+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@tr=($dx,0,$x_min1+0.4+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@levels=($pdl_levels_SII->at(10),$pdl_levels_SII->at(50),$pdl_levels_SII->at(95));
plcol0(0);
plwidth(3.5);
plcont ($pdl_den_BPT_SII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
plline($pdl_cut_x,$pdl_cut_y_SII);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT OI
plvpor (0.630, 0.895, 0.53, 0.74);
plwind ($x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
#pllab($label1_3,"","");
$symbol=0;
$pdl_x_3->inplace->setvaltobad(0);
#plscatter($pdl_x_3,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_OI,my $pdl_fden_BPT_OI, my $pdl_levels_OI)=density_map_XY($pdl_x_3_RG,$pdl_y_RG,$pdl_color_RG,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_OI,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1-0.2+1.1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1-1.1,0,$dy,$y_min1);
@levels=($pdl_levels_OI->at(10),$pdl_levels_OI->at(50),$pdl_levels_OI->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_OI, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
plline($pdl_cut_x,$pdl_cut_y_OI);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);
pllsty(1);
plwidth(1);


#
# GV
#
plscol0a(0,0,0,0,1);
plcol0(0);
#plvpor (0.13, 0.895, 0.10, 0.95);
plvpor (0.10, 0.365, 0.32, 0.53);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcnstv");
#pllab($label1_1,$label2,"");
$symbol=0;
#plscatter($pdl_x,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
#my $NX=70;
#my $NY=70;
#print "RGs\n";
my ($pdl_den_BPT_NII,$pdl_fden_BPT_NII,$pdl_levels_NII)=density_map_XY($pdl_x_GV,$pdl_y_GV,$pdl_color_GV,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(3.5);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"3#[0x212b]-6#[0x212b]");
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
# BPT SII
plvpor(0.365, 0.630, 0.32, 0.53);
plwind ($x_min1+0.4,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
#pllab($label1_2,"","");
$symbol=0;
#plscatter($pdl_x_2,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_SII,my $pdl_fden_BPT_SII, my $pdl_levels_SII)=density_map_XY($pdl_x_2_GV,$pdl_y_GV,$pdl_color_GV,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_SII,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1-0.4)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
#@tr=($dx,0,$x_min1+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@tr=($dx,0,$x_min1+0.4+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@levels=($pdl_levels_SII->at(10),$pdl_levels_SII->at(50),$pdl_levels_SII->at(95));
plcol0(0);
plwidth(3.5);
plcont ($pdl_den_BPT_SII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
plline($pdl_cut_x,$pdl_cut_y_SII);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT OI
plvpor (0.630, 0.895, 0.32, 0.53);
plwind ($x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
#pllab($label1_3,"","");
$symbol=0;
$pdl_x_3->inplace->setvaltobad(0);
#plscatter($pdl_x_3,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_OI,my $pdl_fden_BPT_OI, my $pdl_levels_OI)=density_map_XY($pdl_x_3_GV,$pdl_y_GV,$pdl_color_GV,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_OI,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1-0.2+1.1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1-1.1,0,$dy,$y_min1);
@levels=($pdl_levels_OI->at(10),$pdl_levels_OI->at(50),$pdl_levels_OI->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_OI, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
plline($pdl_cut_x,$pdl_cut_y_OI);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);
pllsty(1);
plwidth(1);



#
# SF
#
plscol0a(0,0,0,0,1);
plcol0(0);
#plvpor (0.13, 0.895, 0.10, 0.95);
plvpor (0.10, 0.365, 0.11, 0.32);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcnstv");
pllab($label1_1,"","");
$symbol=0;
#plscatter($pdl_x,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
my $NX=70;
my $NY=70;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x_SF,$pdl_y_SF,$pdl_color_SF,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
$pdl_fden_BPT_NII->wfits("EW_SFs.fits.gz");
print "SFs= $zmin,$zmax\n";
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(3.5);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,">6#[0x212b]");
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
# BPT SII
plvpor(0.365, 0.630, 0.11, 0.32);
plwind ($x_min1+0.4,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
pllab($label1_2,"","");
$symbol=0;
#plscatter($pdl_x_2,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_SII,my $pdl_fden_BPT_SII, my $pdl_levels_SII)=density_map_XY($pdl_x_2_SF,$pdl_y_SF,$pdl_color_SF,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_SII,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1-0.4)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
#@tr=($dx,0,$x_min1+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@tr=($dx,0,$x_min1+0.4+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@levels=($pdl_levels_SII->at(10),$pdl_levels_SII->at(50),$pdl_levels_SII->at(95));
plcol0(0);
plwidth(3.5);
plcont ($pdl_den_BPT_SII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
plline($pdl_cut_x,$pdl_cut_y_SII);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT OI
plvpor (0.630, 0.895, 0.11, 0.32);
plwind ($x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
pllab($label1_3,"","");
$symbol=0;
$pdl_x_3->inplace->setvaltobad(0);
#plscatter($pdl_x_3,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_OI,my $pdl_fden_BPT_OI, my $pdl_levels_OI)=density_map_XY($pdl_x_3_SF,$pdl_y_SF,$pdl_color_SF,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_OI,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1-0.2+1.1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1-1.1,0,$dy,$y_min1);
@levels=($pdl_levels_OI->at(10),$pdl_levels_OI->at(50),$pdl_levels_OI->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_OI, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
plline($pdl_cut_x,$pdl_cut_y_OI);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);
pllsty(1);
plwidth(1);


READ_cmap_plplot1_r("/home/sanchez/sda2/code/colortables/magma.csv",0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.11, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-2);
plvpor (0.13, 0.895, 0.11, 0.95);
pllab("",$label2,"");

plend();


#########################################################################
# BPT diagram PLPLOT MORPH
#########################################################################

# Output file
print "N = $n\n";
my @x;
my @x_2;
my @x_3;
my @e_x;
my @e_x_2;
my @e_x_3;
my @y;
my @e_y;
my @color;
my @Mass;
$i=0;

my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

#
# Center
#    
#    $nc1=$n_NII_Ha; # NII]/Ha
#    $nc1_2=$n_SII_Ha; # SII]/Ha
#    $nc1_3=$n_OI_Ha; # OII]/Hb
#    $nc2=$n_OIII_Hb; # OIII]/Hb
#    $ncolor=$n_EW_Ha_cen; # EW(Ha)

#
# Re
#    
    $nc1=$n_NII_Ha_Re; # NII]/Ha
    $nc1_2=$n_SII_Ha_Re; # SII]/Ha
    $nc1_3=$n_OI_Ha_Re; # OII]/Hb
    $nc2=$n_OIII_Hb_Re; # OIII]/Hb
    $ncolor=$n_EW_Ha; # EW(Ha)    

if (($data[$nc1] ne "BAD")&&($data[$nc1_2] ne "BAD")&&($data[$nc1_3] ne "BAD")&&($data[$nc2] ne "BAD")&&($data[$ncolor] ne "BAD")&&($data[$nc1+1] ne "BAD")&&($data[$nc1_2+1] ne "BAD")&&($data[$nc1_3+1] ne "BAD")) {
        $x[$i]=$data[$nc1];
        $x_2[$i]=$data[$nc1_2];
        $x_3[$i]=$data[$nc1_3];
        $y[$i]=$data[$nc2];
        $e_x[$i]=$data[$nc1+1];
        $e_x_2[$i]=$data[$nc1_2+1];
        $e_x_3[$i]=$data[$nc1_3+1];
        $e_y[$i]=$data[$nc2+1];
        $color[$i]=log10(abs($data[$ncolor]));
	$a_morph[$i]=$A_MORPH[$j];
	$Mass[$i]=$data[$n_Mass];


    if (($color[$i]>-0.5)&&($e_x[$i]<3)) {
    $i++;
    }
}
        
}
print "I=$i\n";


my $pdl_Morph=pdl(@a_morph);
my $pdl_Mass=pdl(@Mass);
my $pdl_x=pdl(@x);
my $pdl_x_2=pdl(@x_2);
my $pdl_x_3=pdl(@x_3);
my $pdl_y=pdl(@y);
my $pdl_ex=pdl(@e_x);
my $pdl_ex_2=pdl(@e_x_2);
my $pdl_ex_3=pdl(@e_x_3);
my $pdl_ey=pdl(@e_y);
my $pdl_color=pdl(@color);
$pdl_x->inplace->setbadtoval(-12);
$pdl_x_2->inplace->setbadtoval(-12);
$pdl_x_3->inplace->setbadtoval(-12);

@dims=$pdl_x->dims();
print "DIM=@dims,$#x\n";

$pdl_y->inplace->setbadtoval(-12);
$pdl_color->inplace->setbadtoval(-3);
$pdl_size=0.02+0.0*sqrt($pdl_ex**2+$pdl_ey**2);
$pdl_size_2=0.02+0.0*sqrt($pdl_ex_2**2+$pdl_ey**2);
$pdl_size_3=0.02+0.0*sqrt($pdl_ex_3**2+$pdl_ey**2);

$pdl_cut_x=-3+0.02*pdl(0..300);
$pdl_cut_y=-0.7+0.2-3.67*$pdl_cut_x;
$pdl_cut_y2=-1.7+0.5-3.67*$pdl_cut_x;
$pdl_cut_y3=0.61/($pdl_cut_x-0.05)+1.3;
$pdl_cut_y4=0.61/($pdl_cut_x-0.47)+1.19;
$pdl_cut_y3->inplace->clip(-2,1.1);
$pdl_cut_y4->inplace->clip(-2,1.1);
$pdl_cut_y3->inplace->setvaltobad(1.1);
$pdl_cut_y4->inplace->setvaltobad(1.1);
$pdl_cut_y_SII=0.61/($pdl_cut_x-0.3)+1.3;
$pdl_cut_y_SII=0.61/($pdl_cut_x-0.3)+1.3;
$pdl_cut_y_SII_AGNs=1.89*($pdl_cut_x)+0.76;
$pdl_cut_y_OI=0.73/(($pdl_cut_x+0.59))+1.33;#+1.10;
$pdl_cut_y_OI_AGNs=1.18*($pdl_cut_x)+1.30;
$pdl_cut_y_OIII_AGNs=1.14*($pdl_cut_x)+0.36;

$pdl_cut_y_SII->inplace->clip(-2,1.1);
$pdl_cut_y_OI->inplace->clip(-2,1.1);
$pdl_cut_y_SII->inplace->setvaltobad(1.1);
$pdl_cut_y_OI->inplace->setvaltobad(1.1);

$label1_1='log([NII]/H#ga';
$label1_2='log([SII]/H#ga)';
$label1_3='log([OI]/H#ga)';
$label2='log([OIII]/H#gb)';
$label_cb='log|EW(H#ga)|';

#$x_min1=-1.75;
#$x_max1=0.75;
#$y_min1=-1.6;
#$y_max1=1.6;

$plot_file="plBPT_mass_den".$pldev_suf; #$dev="pdfcairo";
my $NX=100;
my $NY=100;
my ($pdl_Mass_Morph0,$pdl_x_Morph0,$pdl_y_Morph0,$pdl_x_2_Morph0,$pdl_x_3_Morph0,$pdl_color_Morph0)=where($pdl_Mass,$pdl_x,$pdl_y,$pdl_x_2,$pdl_x_3,$pdl_color,$pdl_Morph<=9);
my ($pdl_Mass_Morph2,$pdl_x_Morph2,$pdl_y_Morph2,$pdl_x_2_Morph2,$pdl_x_3_Morph2,$pdl_color_Morph2)=where($pdl_Mass,$pdl_x,$pdl_y,$pdl_x_2,$pdl_x_3,$pdl_color,$pdl_Morph>=14);
my ($pdl_Mass_Morph1_0,$pdl_x_Morph1_0,$pdl_y_Morph1_0,$pdl_x_2_Morph1_0,$pdl_x_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_Mass,$pdl_x,$pdl_y,$pdl_x_2,$pdl_x_3,$pdl_color,$pdl_Morph,$pdl_Morph>9);
my ($pdl_Mass_Morph1,$pdl_x_Morph1,$pdl_y_Morph1,$pdl_x_2_Morph1,$pdl_x_3_Morph1,$pdl_color_Morph1)=where($pdl_Mass_Morph1_0,$pdl_x_Morph1_0,$pdl_y_Morph1_0,$pdl_x_2_Morph1_0,$pdl_x_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);

#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 800;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);


#
# All masses
#

#
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcnstv");
$symbol=0;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x,$pdl_y,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"ALL");
#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_x,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x_Morph0,$pdl_y_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"E/S0");
#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_x,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x_Morph1,$pdl_y_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_x,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x_Morph2,$pdl_y_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");


@Mass_limit=(7,9.5,10.5,11,13.5);

for (my $I=0;$I<$#Mass_limit;$I++) {
    my $min_M=$Mass_limit[$I];
    my $max_M=$Mass_limit[$I+1];
    my $y1_view=0.10+0.17*($I+1);
    my $y0_view=0.10+0.17*($I);
    
my ($pdl_Mass_Mass0,$pdl_x_Mass0,$pdl_y_Mass0,$pdl_x_2_Mass0,$pdl_x_3_Mass0,$pdl_color_Mass0,$pdl_Morph_Mass0)=where($pdl_Mass,$pdl_x,$pdl_y,$pdl_x_2,$pdl_x_3,$pdl_color,$pdl_Morph,$pdl_Mass>$min_M);
my ($pdl_Mass_Mass,$pdl_x_Mass,$pdl_y_Mass,$pdl_x_2_Mass,$pdl_x_3_Mass,$pdl_color_Mass,$pdl_Morph_Mass)=where($pdl_Mass_Mass0,$pdl_x_Mass0,$pdl_y_Mass0,$pdl_x_2_Mass0,$pdl_x_3_Mass0,$pdl_color_Mass0,$pdl_Morph_Mass0,$pdl_Mass_Mass0<$max_M);
    
my ($pdl_Mass_Morph0,$pdl_x_Morph0,$pdl_y_Morph0,$pdl_x_2_Morph0,$pdl_x_3_Morph0,$pdl_color_Morph0)=where($pdl_Mass_Mass,$pdl_x_Mass,$pdl_y_Mass,$pdl_x_2_Mass,$pdl_x_3_Mass,$pdl_color_Mass,$pdl_Morph_Mass<=9);
my ($pdl_Mass_Morph2,$pdl_x_Morph2,$pdl_y_Morph2,$pdl_x_2_Morph2,$pdl_x_3_Morph2,$pdl_color_Morph2)=where($pdl_Mass_Mass,$pdl_x_Mass,$pdl_y_Mass,$pdl_x_2_Mass,$pdl_x_3_Mass,$pdl_color_Mass,$pdl_Morph_Mass>=14);
my ($pdl_Mass_Morph1_0,$pdl_x_Morph1_0,$pdl_y_Morph1_0,$pdl_x_2_Morph1_0,$pdl_x_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_Mass,$pdl_x,$pdl_y,$pdl_x_2,$pdl_x_3,$pdl_color,$pdl_Morph_Mass,$pdl_Morph_Mass>9);
my ($pdl_Mass_Morph1,$pdl_x_Morph1,$pdl_y_Morph1,$pdl_x_2_Morph1,$pdl_x_3_Morph1,$pdl_color_Morph1)=where($pdl_Mass_Morph1_0,$pdl_x_Morph1_0,$pdl_y_Morph1_0,$pdl_x_2_Morph1_0,$pdl_x_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
my @dims=$pdl_Mass_Mass->dims();
print "$min_M<M<$max_M #=@dims\n";
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcnstv");
    } else {
	plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcnstv");
    }
$symbol=0;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x_Mass,$pdl_y_Mass,$pdl_color_Mass,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
my $label_now="".$min_M."-".$max_M."";
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,$label_now);


#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
    } else {
	plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
    }
#plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x_Morph0,$pdl_y_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
    #plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"E/S0");
#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
    } else {
	plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
    }
#plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_x,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x_Morph1,$pdl_y_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
#plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
    } else {
	plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
    }
#plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_x,$pdl_y,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_x_Morph2,$pdl_y_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
#plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

}

######################

#READ_cmap_plplot1_r("/home/sanchez/sda2/code/colortables/magma.csv",0.7);
READ_cmap_plplot1_r($pl_colormap1,0.7);
#my @stats=stats($pdl_color);
#my $zmin=$stats[3];
#my $zmax=$stats[4];
plcol0(0);
plcolorbar(0.90, 0.93, 0.10, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-2);
plvpor (0.13, 0.895, 0.10, 0.95);
pllab($label1_1,$label2,"");

#plmtex(3.2,0,-1.8,"l",$label2);
plend();

#########################################################################
# SFMS by Morphology
#########################################################################


# Output file
print "#########################################################################\n";
print "N = $n | SFMS\n";
my @color;
my @Mass;
my @SFR_Ha;
my @SFR_ssp;
my @a_morph;
$i=0;

my @a_morph;
my @AGE_type;

my $n_m=0;
open(OUT,">ARAA_sample_morph.csv");
print OUT "# (1) name\n";
print OUT "# (2) survey\n";
print OUT "# (3) Mass\n";
print OUT "# (4) SFR_Ha\n";
print OUT "# (5) EW_Ha_Re\n";
print OUT "# (6) MORPH\n";
print OUT "# (7) ION_TYPE\n";
print OUT "# (8) R_FoV/Re\n";
print OUT "# (9) Re_arcsec\n";
for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    if ($name_now =~ "SAMI") {
	$Mass[$i]=$Mass[$i]+0.0;
    }
    
    $SFR_Ha[$i]=$data[$n_SFR_Ha];
    $SFR_ssp[$i]=$data[$n_SFR_ssp];
    $color[$i]=log10(abs($data[$ncolor]));
    $AGN_type[$i]=$a_TYPE{$name_now};
    my $spax_size=1;
    my $include=1;
    if (($SAMPLE{$name_now} eq "SAMI")||($SAMPLE{$name_now} eq "MaNGA")) {
	$spax_size=0.5;
    }
    if (($SAMPLE{$name_now} eq "MUSE")) {
	$spax_size=0.2;
    }
    if (($SAMPLE{$name_now} eq "MaNGA")&&($name_now !~ "1270")) {
	$include=0;
    }

    my $FoV=$data[$n_FoV];#*$spax_size;
    my $Re_arc=$data[$n_Re_arc];
    if (($SAMPLE{$name_now} ne "MUSE")&&($Re_arc<5)) {
	$include=0;
    }
    if ($FoV<1.5) {
	$include=0;
    }
    
    if (($include==1)&&($Mass[$i]>6)&&($Mass[$i]<13)&&($SFR_Ha[$i]>-5)&&($SFR_Ha[$i]<3)) {
	if ($a_morph[$i]>-1) {
	    print OUT "$name_now,$SAMPLE{$name_now},$Mass[$i],$SFR_Ha[$i],$data[$n_EW_Ha],$a_morph[$i],$a_TYPE{$name_now},$FoV,$Re_arc\n";
	    $n_m++;
	}
	$i++;
    }
}
close(OUT);        
print "I=$i, $n_m with morphology and well resolved\n";



my $pdl_Morph=pdl(@a_morph);
my $pdl_SFR_Ha=pdl(@SFR_Ha);
my $pdl_SFR_ssp=pdl(@SFR_ssp);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);
my $pdl_AGN_type=pdl(@AGN_type);

$x_min1=7.5;
$x_max1=12.3;
$y_min1=-4.5;
$y_max1=2.5;
$label_S="log(SFR/M#d#[0x2299]#u)";
$label_M="log(M#d*#u/M#d#[0x2299]#u)";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";
#my @stats=stats($pdl_color);
#my $zmin=$stats[3];
#my $zmax=$stats[4];



$plot_file="plSFMS".$pldev_suf; #$dev="pdfcairo";
my $NX=70;
my $NY=70;
my ($pdl_Mass_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_AGN_type_IN)=where($pdl_Mass,$pdl_SFR_Ha,$pdl_SFR_ssp,$pdl_color,$pdl_Morph,$pdl_AGN_type,$pdl_Morph>-1);
my ($pdl_Mass_Morph0,$pdl_SFR_Ha_Morph0,$pdl_SFR_ssp_Morph0,$pdl_color_Morph0,$pdl_AGN_type_Morph0)=where($pdl_Mass_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_color_IN,$pdl_AGN_type_IN,$pdl_Morph_IN<=9);
my ($pdl_Mass_Morph2,$pdl_SFR_Ha_Morph2,$pdl_SFR_ssp_Morph2,$pdl_color_Morph2,$pdl_AGN_type_Morph2)=where($pdl_Mass_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_color_IN,$pdl_AGN_type_IN,$pdl_Morph_IN>=14);
my ($pdl_Mass_Morph1_0,$pdl_SFR_Ha_Morph1_0,$pdl_SFR_ssp_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0,$pdl_AGN_type_Morph1_0)=where($pdl_Mass_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_AGN_type_IN,$pdl_Morph_IN>9);
my ($pdl_Mass_Morph1,$pdl_SFR_Ha_Morph1,$pdl_SFR_ssp_Morph1,$pdl_color_Morph1,$pdl_Morph1,$pdl_AGN_type_Morph1)=where($pdl_Mass_Morph1_0,$pdl_SFR_Ha_Morph1_0,$pdl_SFR_ssp_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0,$pdl_AGN_type_Morph1_0,$pdl_Morph1_0<14);





#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
$color_AGN=255;
#READ_cmap_plplot0_r($pl_colormap0,0.5);
READ_cmap_plplot0($pl_colormap0,0.5);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# Ha
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_SFR_Ha,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);

# AGNs now
my ($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0)=where($pdl_Mass_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_AGN_type_IN,$pdl_AGN_type_IN>=2);
my ($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,$pdl_SFR_ssp_AGNs,$pdl_AGN_type_AGNs)=where($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0,$pdl_AGN_type_AGNs1_0<=3);
plcol0($color_AGN);
plpoin($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,17);
plcol0(0);



pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"H#ga");
#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_SFR_Ha_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
# AGNs now
my ($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0)=where($pdl_Mass_Morph0,$pdl_SFR_Ha_Morph0,$pdl_SFR_ssp_Morph0,$pdl_AGN_type_Morph0,$pdl_AGN_type_Morph0>=2);
my ($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,$pdl_SFR_ssp_AGNs,$pdl_AGN_type_AGNs)=where($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0,$pdl_AGN_type_AGNs1_0<=3);
plcol0($color_AGN);
plpoin($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,17);
plcol0(0);

pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_SFR_Ha_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
# AGNs now
my ($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0)=where($pdl_Mass_Morph1,$pdl_SFR_Ha_Morph1,$pdl_SFR_ssp_Morph1,$pdl_AGN_type_Morph1,$pdl_AGN_type_Morph1>=2);
my ($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,$pdl_SFR_ssp_AGNs,$pdl_AGN_type_AGNs)=where($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0,$pdl_AGN_type_AGNs1_0<=3);
plcol0($color_AGN);
plpoin($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,17);
plcol0(0);

pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_SFR_Ha_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
# AGNs now
my ($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0)=where($pdl_Mass_Morph2,$pdl_SFR_Ha_Morph2,$pdl_SFR_ssp_Morph2,$pdl_AGN_type_Morph2,$pdl_AGN_type_Morph2>=2);
my ($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,$pdl_SFR_ssp_AGNs,$pdl_AGN_type_AGNs)=where($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0,$pdl_AGN_type_AGNs1_0<=3);
plcol0($color_AGN);
plpoin($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,17);
plcol0(0);

pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



# SSP
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_SFR_ssp,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
# AGNs now
my ($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0)=where($pdl_Mass_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_AGN_type_IN,$pdl_AGN_type_IN>=2);
my ($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,$pdl_SFR_ssp_AGNs,$pdl_AGN_type_AGNs)=where($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0,$pdl_AGN_type_AGNs1_0<=3);
plcol0($color_AGN);
plpoin($pdl_Mass_AGNs,$pdl_SFR_ssp_AGNs,17);
plcol0(0);

pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"SSP");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_SFR_ssp_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
# AGNs now
my ($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0)=where($pdl_Mass_Morph0,$pdl_SFR_Ha_Morph0,$pdl_SFR_ssp_Morph0,$pdl_AGN_type_Morph0,$pdl_AGN_type_Morph0>=2);
my ($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,$pdl_SFR_ssp_AGNs,$pdl_AGN_type_AGNs)=where($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0,$pdl_AGN_type_AGNs1_0<=3);
plcol0($color_AGN);
plpoin($pdl_Mass_AGNs,$pdl_SFR_ssp_AGNs,17);
plcol0(0);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_SFR_ssp_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
# AGNs now
my ($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0)=where($pdl_Mass_Morph1,$pdl_SFR_Ha_Morph1,$pdl_SFR_ssp_Morph1,$pdl_AGN_type_Morph1,$pdl_AGN_type_Morph1>=2);
my ($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,$pdl_SFR_ssp_AGNs,$pdl_AGN_type_AGNs)=where($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0,$pdl_AGN_type_AGNs1_0<=3);
plcol0($color_AGN);
plpoin($pdl_Mass_AGNs,$pdl_SFR_ssp_AGNs,17);
plcol0(0);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_SFR_ssp_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
# AGNs now
my ($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0)=where($pdl_Mass_Morph2,$pdl_SFR_Ha_Morph2,$pdl_SFR_ssp_Morph2,$pdl_AGN_type_Morph2,$pdl_AGN_type_Morph2>=2);
my ($pdl_Mass_AGNs,$pdl_SFR_Ha_AGNs,$pdl_SFR_ssp_AGNs,$pdl_AGN_type_AGNs)=where($pdl_Mass_AGNs1_0,$pdl_SFR_Ha_AGNs1_0,$pdl_SFR_ssp_AGNs1_0,$pdl_AGN_type_AGNs1_0,$pdl_AGN_type_AGNs1_0<=3);
plcol0($color_AGN);
plpoin($pdl_Mass_AGNs,$pdl_SFR_ssp_AGNs,17);
plcol0(0);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();



#########################################################################
# M-OH by Morphology
#########################################################################


# Output file
print "#########################################################################\n";
print "N = $n | M-OH\n";
my @color;
my @Mass;
my @OH_t2;
my @OH_pyqz;
my @a_morph;
$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $OH_t2[$i]=$data[$n_OH_t2];
    $OH_pyqz[$i]=$data[$n_OH_pyqz];
    $color[$i]=log10(abs($data[$ncolor]));
    #    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($OH_t2[$i]>7.5)&&($OH_t2[$i]<9.5)&&($OH_pyqz[$i]>7.5)&&($OH_pyqz[$i]<9.5)) {
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($OH_t2[$i]>7.5)&&($OH_t2[$i]<9.5)&&($OH_pyqz[$i]>7.5)&&($OH_pyqz[$i]<9.5)) {
#    print "($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($OH_t2[$i]>7.5)&&($OH_t2[$i]<9.5)&&($OH_pyqz[$i]>7.5)&&($OH_pyqz[$i]<9.5)\n";
	$i++;
    }
}
        
print "I=$i\n";



my $pdl_Morph=pdl(@a_morph);
my $pdl_OH_t2=pdl(@OH_t2);
my $pdl_OH_pyqz=pdl(@OH_pyqz);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);


$x_min1=7.5;
$x_max1=12.3;
#$y_min1=-4.5;
#$y_max1=2.5;
$y_min1=8.1;
$y_max1=9.4;
$label_S="12+log(O/H)";
$label_M="log(M#d*#u/M#d#[0x2299]#u)";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";



$plot_file="plM_OH".$pldev_suf; #$dev="pdfcairo";
my $NX=70;
my $NY=70;

my ($pdl_Mass_IN,$pdl_OH_t2_IN,$pdl_OH_pyqz_IN,$pdl_color_IN,$pdl_Morph_IN)=where($pdl_Mass,$pdl_OH_t2,$pdl_OH_pyqz,$pdl_color,$pdl_Morph,$pdl_Morph>-1);
my ($pdl_Mass_Morph0,$pdl_OH_t2_Morph0,$pdl_OH_pyqz_Morph0,$pdl_color_Morph0)=where($pdl_Mass_IN,$pdl_OH_t2_IN,$pdl_OH_pyqz_IN,$pdl_color_IN,$pdl_Morph_IN<=9);
my ($pdl_Mass_Morph2,$pdl_OH_t2_Morph2,$pdl_OH_pyqz_Morph2,$pdl_color_Morph2)=where($pdl_Mass_IN,$pdl_OH_t2_IN,$pdl_OH_pyqz_IN,$pdl_color_IN,$pdl_Morph_IN>=14);
my ($pdl_Mass_Morph1_0,$pdl_OH_t2_Morph1_0,$pdl_OH_pyqz_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_Mass_IN,$pdl_OH_t2_IN,$pdl_OH_pyqz_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Morph_IN>9);
my ($pdl_Mass_Morph1,$pdl_OH_t2_Morph1,$pdl_OH_pyqz_Morph1,$pdl_color_Morph1)=where($pdl_Mass_Morph1_0,$pdl_OH_t2_Morph1_0,$pdl_OH_pyqz_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# M-OH t2
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_OH_t2,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"t2");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_OH_t2_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_OH_t2_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_OH_t2_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



# M-OH pyqz
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcnst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_OH_pyqz,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"pyqz");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_OH_pyqz_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_OH_pyqz_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_OH_pyqz_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();



#########################################################################
# M-ZH by Morphology
#########################################################################


# Output file
print "#########################################################################\n";
print "N = $n | M-ZH\n";
my @color;
my @Mass;
my @ZH_LW;
my @ZH_MW;
my @a_morph;
$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $ZH_LW[$i]=$data[$n_ZH_LW_Re];
    $ZH_MW[$i]=$data[$n_ZH_MW_Re];
    $color[$i]=log10(abs($data[$ncolor]));
    #    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($ZH_LW[$i]>7.5)&&($ZH_LW[$i]<9.5)&&($ZH_MW[$i]>7.5)&&($ZH_MW[$i]<9.5)) {
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($ZH_LW[$i]>-3)&&($ZH_LW[$i]<1)&&($ZH_MW[$i]>-3)&&($ZH_MW[$i]<1)) {
#    print "($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($ZH_LW[$i]>7.5)&&($ZH_LW[$i]<9.5)&&($ZH_MW[$i]>7.5)&&($ZH_MW[$i]<9.5)\n";
	$i++;
    }
}
        
print "I=$i\n";



my $pdl_Morph=pdl(@a_morph);
my $pdl_ZH_LW=pdl(@ZH_LW);
my $pdl_ZH_MW=pdl(@ZH_MW);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);


$x_min1=7.5;
$x_max1=12.3;

$y_min1=-0.8;
$y_max1=0.3;
$label_S="[Z/H]";
$label_M="log(M#d*#u/M#d#[0x2299]#u)";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";



$plot_file="plM_ZH".$pldev_suf; #$dev="pdfcairo";
my $NX=70;
my $NY=70;

my ($pdl_Mass_IN,$pdl_ZH_LW_IN,$pdl_ZH_MW_IN,$pdl_color_IN,$pdl_Morph_IN)=where($pdl_Mass,$pdl_ZH_LW,$pdl_ZH_MW,$pdl_color,$pdl_Morph,$pdl_Morph>-1);
my ($pdl_Mass_Morph0,$pdl_ZH_LW_Morph0,$pdl_ZH_MW_Morph0,$pdl_color_Morph0)=where($pdl_Mass_IN,$pdl_ZH_LW_IN,$pdl_ZH_MW_IN,$pdl_color_IN,$pdl_Morph_IN<=9);
my ($pdl_Mass_Morph2,$pdl_ZH_LW_Morph2,$pdl_ZH_MW_Morph2,$pdl_color_Morph2)=where($pdl_Mass_IN,$pdl_ZH_LW_IN,$pdl_ZH_MW_IN,$pdl_color_IN,$pdl_Morph_IN>=14);
my ($pdl_Mass_Morph1_0,$pdl_ZH_LW_Morph1_0,$pdl_ZH_MW_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_Mass_IN,$pdl_ZH_LW_IN,$pdl_ZH_MW_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Morph_IN>9);
my ($pdl_Mass_Morph1,$pdl_ZH_LW_Morph1,$pdl_ZH_MW_Morph1,$pdl_color_Morph1)=where($pdl_Mass_Morph1_0,$pdl_ZH_LW_Morph1_0,$pdl_ZH_MW_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# M-OH t2
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_ZH_LW,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"LW");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_ZH_LW_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_ZH_LW_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_ZH_LW_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



# M-OH pyqz
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcnst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_ZH_MW,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"MW");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_ZH_MW_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_ZH_MW_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 0.5, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_ZH_MW_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();


#########################################################################
# M-Age by Morphology
#########################################################################


# Output file
print "#########################################################################\n";
print "N = $n | M-Age\n";
my @color;
my @Mass;
my @Age_LW;
my @Age_MW;
my @a_morph;
$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $Age_LW[$i]=$data[$n_Age_LW_Re];
    $Age_MW[$i]=$data[$n_Age_MW_Re];
    $color[$i]=log10(abs($data[$ncolor]));
    #    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($Age_LW[$i]>7.5)&&($Age_LW[$i]<9.5)&&($Age_MW[$i]>7.5)&&($Age_MW[$i]<9.5)) {
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($Age_LW[$i]>6)&&($Age_LW[$i]<13)&&($Age_MW[$i]>6)&&($Age_MW[$i]<13)) {
#    print "($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($Age_LW[$i]>7.5)&&($Age_LW[$i]<9.5)&&($Age_MW[$i]>7.5)&&($Age_MW[$i]<9.5)\n";
	$i++;
    }
}
        
print "I=$i\n";



my $pdl_Morph=pdl(@a_morph);
my $pdl_Age_LW=pdl(@Age_LW);
my $pdl_Age_MW=pdl(@Age_MW);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);


#$x_min1=7.6;
#$x_max1=12.3;
$x_min1=7.5;
$x_max1=12.3;
#$y_min1=-4.5;
#$y_max1=2.5;
$y_min1=7.5;
$y_max1=10.3;
$label_S="log(Age/yr)";
$label_M="log(M#d*#u/M#d#[0x2299]#u)";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";



$plot_file="plM_Age".$pldev_suf; #$dev="pdfcairo";
my $NX=70;
my $NY=70;

my ($pdl_Mass_IN,$pdl_Age_LW_IN,$pdl_Age_MW_IN,$pdl_color_IN,$pdl_Morph_IN)=where($pdl_Mass,$pdl_Age_LW,$pdl_Age_MW,$pdl_color,$pdl_Morph,$pdl_Morph>-1);
my ($pdl_Mass_Morph0,$pdl_Age_LW_Morph0,$pdl_Age_MW_Morph0,$pdl_color_Morph0)=where($pdl_Mass_IN,$pdl_Age_LW_IN,$pdl_Age_MW_IN,$pdl_color_IN,$pdl_Morph_IN<=9);
my ($pdl_Mass_Morph2,$pdl_Age_LW_Morph2,$pdl_Age_MW_Morph2,$pdl_color_Morph2)=where($pdl_Mass_IN,$pdl_Age_LW_IN,$pdl_Age_MW_IN,$pdl_color_IN,$pdl_Morph_IN>=14);
my ($pdl_Mass_Morph1_0,$pdl_Age_LW_Morph1_0,$pdl_Age_MW_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_Mass_IN,$pdl_Age_LW_IN,$pdl_Age_MW_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Morph_IN>9);
my ($pdl_Mass_Morph1,$pdl_Age_LW_Morph1,$pdl_Age_MW_Morph1,$pdl_color_Morph1)=where($pdl_Mass_Morph1_0,$pdl_Age_LW_Morph1_0,$pdl_Age_MW_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# M-OH t2
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1, 0.5, "bcst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_Age_LW,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"LW");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1, 0.5, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_Age_LW_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1, 0.5, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_Age_LW_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1, 0.5, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_Age_LW_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



$y_min1=8.3;
$y_max1=10.3;

# M-OH pyqz
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1, 0.5, "bcnst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_Age_MW,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"MW");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1, 0.5, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_Age_MW_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1, 0.5, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_Age_MW_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1, 0.5, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_Age_MW_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();




# Output file
print "#########################################################################\n";
print "N = $n | M-Mgas\n";
my @color;
my @Mass;
my @Mass_gas;
my @Mass_gas_ssp;
my @a_morph;
$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $Mass_gas[$i]=$data[$n_Mass_gas];
    $Mass_gas_ssp[$i]=$data[$n_Mass_gas_ssp];
    if ($SAMPLE{$name_now} ne "CALIFA") {
	$Mass_gas[$i]=$data[$n_Mass_gas]/1.09;
	$Mass_gas_ssp[$i]=$data[$n_Mass_gas_ssp]/1.09;
    }

#    if ($name_now =~ "manga") {
#	$Mass[$i]=$Mass[$i]+0.11;
#	$Mass_gas_ssp[$i]=$Mass_gas_ssp[$i]+0.2;
#   }
#    if ($name_now =~ "SAMI") {
#	$Mass[$i]=$Mass[$i]+0.21;
#	$Mass_gas_ssp[$i]=$Mass_gas_ssp[$i]+0.21;
    #    }
    

    
    $color[$i]=log10(abs($data[$ncolor]));
    #    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($Mass_gas[$i]>7.5)&&($Mass_gas[$i]<9.5)&&($Mass_gas_ssp[$i]>7.5)&&($Mass_gas_ssp[$i]<9.5)) {
#    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($Mass_gas[$i]>4)&&($Mass_gas[$i]<13)&&($Mass_gas_ssp[$i]>4)&&($Mass_gas_ssp[$i]<13)&&(($SAMPLE{$name_now} eq "MaNGA")||($SAMPLE{$name_now} eq "MUSE")||($SAMPLE{$name_now} eq "CALIFA"))) {
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($Mass_gas[$i]>4)&&($Mass_gas[$i]<13)&&($Mass_gas_ssp[$i]>4)&&($Mass_gas_ssp[$i]<13)) {
#    print "($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($Mass_gas[$i]>7.5)&&($Mass_gas[$i]<9.5)&&($Mass_gas_ssp[$i]>7.5)&&($Mass_gas_ssp[$i]<9.5)\n";
	$i++;
    }
}
        
print "I=$i\n";




my $pdl_Morph=pdl(@a_morph);
my $pdl_Mass_gas=pdl(@Mass_gas);
my $pdl_Mass_gas_ssp=pdl(@Mass_gas_ssp);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);


$x_min1=7.5;
$x_max1=12.3;
#$y_min1=-4.5;
#$y_max1=2.5;
$y_min1=6.3;
$y_max1=11.1;

#$label_S="log(M#d*#u/M#dgas,Av#u)";
$label_S="log(M#dgas#u/M#d#[0x2299]#u)";
$label_M="log(M#d*#u/M#d#[0x2299]#u)";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";



$plot_file="plM_Mgas".$pldev_suf; #$dev="pdfcairo";
my $NX=70;
my $NY=70;

my ($pdl_Mass_IN,$pdl_Mass_gas_IN,$pdl_Mass_gas_ssp_IN,$pdl_color_IN,$pdl_Morph_IN)=where($pdl_Mass,$pdl_Mass_gas,$pdl_Mass_gas_ssp,$pdl_color,$pdl_Morph,$pdl_Morph>-1);
my ($pdl_Mass_Morph0,$pdl_Mass_gas_Morph0,$pdl_Mass_gas_ssp_Morph0,$pdl_color_Morph0)=where($pdl_Mass_IN,$pdl_Mass_gas_IN,$pdl_Mass_gas_ssp_IN,$pdl_color_IN,$pdl_Morph_IN<=9);
my ($pdl_Mass_Morph2,$pdl_Mass_gas_Morph2,$pdl_Mass_gas_ssp_Morph2,$pdl_color_Morph2)=where($pdl_Mass_IN,$pdl_Mass_gas_IN,$pdl_Mass_gas_ssp_IN,$pdl_color_IN,$pdl_Morph_IN>=14);
my ($pdl_Mass_Morph1_0,$pdl_Mass_gas_Morph1_0,$pdl_Mass_gas_ssp_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_Mass_IN,$pdl_Mass_gas_IN,$pdl_Mass_gas_ssp_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Morph_IN>9);
my ($pdl_Mass_Morph1,$pdl_Mass_gas_Morph1,$pdl_Mass_gas_ssp_Morph1,$pdl_color_Morph1)=where($pdl_Mass_Morph1_0,$pdl_Mass_gas_Morph1_0,$pdl_Mass_gas_ssp_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# M-OH t2
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_Mass_gas,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.2*($y_max1-$y_min1),0,0,0,"Av,gas");
#plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Av,gas");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_Mass_gas_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_Mass_gas_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_Mass_gas_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



# M-OH pyqz
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_Mass_gas_ssp,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.2*($y_max1-$y_min1),0,0,0,"Av,ssp");
#plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Av,ssp");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_Mass_gas_ssp_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_Mass_gas_ssp_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_Mass_gas_ssp_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();


#########################################################################
# SFMS by Morphology
#########################################################################


# Output file
print "#########################################################################\n";
print "N = $n | SFMS\n";
my @color;
my @Mass;
my @SFR_Ha;
my @SFR_ssp;
my @a_morph;
my @Mass_gas;
my @Mass_gas_ssp;






$i=0;

my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    if ($name_now =~ "SAMI") {
	$Mass[$i]=$Mass[$i]+0.0;
    }
    
    $SFR_Ha[$i]=$data[$n_SFR_Ha];
    $SFR_ssp[$i]=$data[$n_SFR_ssp];
    $color[$i]=log10(abs($data[$ncolor]));

    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $Mass_gas[$i]=$data[$n_Mass_gas];
    $Mass_gas_ssp[$i]=$data[$n_Mass_gas_ssp];
#    if ($name_now =~ "manga") {
#	$Mass[$i]=$Mass[$i]+0.11;
#	$Mass_gas_ssp[$i]=$Mass_gas_ssp[$i]+0.2;
#   }
#    if ($name_now =~ "SAMI") {
#	$Mass[$i]=$Mass[$i]+0.21;
#	$Mass_gas_ssp[$i]=$Mass_gas_ssp[$i]+0.21;
#    }

    if ($SAMPLE{$name_now} ne "CALIFA") {
	$Mass_gas[$i]=$data[$n_Mass_gas]/1.09;
	$Mass_gas_ssp[$i]=$data[$n_Mass_gas_ssp]/1.09;
    }
    $color[$i]=log10(abs($data[$ncolor]));
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($Mass_gas[$i]>4)&&($Mass_gas[$i]<13)&&($Mass_gas_ssp[$i]>4)&&($Mass_gas_ssp[$i]<13)&&($SFR_Ha[$i]>-5)&&($SFR_Ha[$i]<3)) {
	$i++;
    }
}
        
print "I=$i\n";




my $pdl_Morph=pdl(@a_morph);
my $pdl_SFR_Ha=pdl(@SFR_Ha);
my $pdl_SFR_ssp=pdl(@SFR_ssp);
my $pdl_Mass=pdl(@Mass);
my $pdl_Mass_gas=pdl(@Mass_gas);
my $pdl_Mass_gas_ssp=pdl(@Mass_gas_ssp);
my $pdl_color=pdl(@color);

my $pdl_f_gas=10**($pdl_Mass_gas)/(10**($pdl_Mass_gas)+10**($pdl_Mass));


#$x_min1=6.7;
#$x_max1=11.5;
$x_min1=6.3;
$x_max1=11.1;

$y_min1=-4.5;
$y_max1=2.5;
$label_S="log(SFR/M#d#[0x2299]#u)";
$label_M="log(M#dgas#u/M#d#[0x2299]#u)";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";
#my @stats=stats($pdl_color);
#my $zmin=$stats[3];
#my $zmax=$stats[4];



$plot_file="plSK".$pldev_suf; #$dev="pdfcairo";
my $NX=70;
my $NY=70;
my ($pdl_Mass_IN,$pdl_Mass_gas_IN,$pdl_Mass_gas_ssp_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_color_IN,$pdl_Morph_IN)=where($pdl_Mass,$pdl_Mass_gas,$pdl_Mass_gas_ssp,$pdl_SFR_Ha,$pdl_SFR_ssp,$pdl_color,$pdl_Morph,$pdl_Morph>-1);

my ($pdl_Mass_Morph0,$pdl_Mass_gas_Morph0,$pdl_Mass_gas_ssp_Morph0,$pdl_SFR_Ha_Morph0,$pdl_SFR_ssp_Morph0,$pdl_color_Morph0)=where($pdl_Mass_IN,$pdl_Mass_gas_IN,$pdl_Mass_gas_ssp_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_color_IN,$pdl_Morph_IN<=9);
my ($pdl_Mass_Morph2,$pdl_Mass_gas_Morph2,$pdl_Mass_gas_ssp_Morph2,$pdl_SFR_Ha_Morph2,$pdl_SFR_ssp_Morph2,$pdl_color_Morph2)=where($pdl_Mass_IN,$pdl_Mass_gas_IN,$pdl_Mass_gas_ssp_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_color_IN,$pdl_Morph_IN>=14);
my ($pdl_Mass_Morph1_0,$pdl_Mass_gas_Morph1_0,$pdl_Mass_gas_ssp_Morph1_0,$pdl_SFR_Ha_Morph1_0,$pdl_SFR_ssp_Morph1_0,$pdl_color_Morph1_0)=where($pdl_Mass_IN,$pdl_Mass_gas_IN,$pdl_Mass_gas_ssp_IN,$pdl_SFR_Ha_IN,$pdl_SFR_ssp_IN,$pdl_color_IN,$pdl_Morph_IN>9);
my ($pdl_Mass_Morph1,$pdl_Mass_gas_Morph1,$pdl_Mass_gas_ssp_Morph1,$pdl_SFR_Ha_Morph1,$pdl_SFR_ssp_Morph1,$pdl_color_Morph1)=where($pdl_Mass_Morph1_0,$pdl_Mass_gas_Morph1_0,$pdl_Mass_gas_ssp_Morph1_0,$pdl_SFR_Ha_Morph1_0,$pdl_SFR_ssp_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);

#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# Ha
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_gas,$pdl_SFR_Ha,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.35*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"H#ga,gas");
#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_gas_Morph0,$pdl_SFR_Ha_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_gas_Morph1,$pdl_SFR_Ha_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_gas_Morph2,$pdl_SFR_Ha_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



# SSP
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_gas_ssp,$pdl_SFR_ssp,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"SSP");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_gas_ssp_Morph0,$pdl_SFR_ssp_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_gas_ssp_Morph1,$pdl_SFR_ssp_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_gas_ssp_Morph2,$pdl_SFR_ssp_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();


#########################################################################
# fgas-OH by Morphology
#########################################################################


# Output file
print "#########################################################################\n";
print "N = $n | fgas-OH\n";
my @color;
my @Mass;
my @OH_t2;
my @OH_pyqz;
my @a_morph;
my @Mass_gas;
my @Mass_gas_ssp;

$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $OH_t2[$i]=$data[$n_OH_t2];
    $OH_pyqz[$i]=$data[$n_OH_pyqz];
    $color[$i]=log10(abs($data[$ncolor]));

    $Mass_gas[$i]=$data[$n_Mass_gas];
    $Mass_gas_ssp[$i]=$data[$n_Mass_gas_ssp];
    if ($name_now =~ "manga") {
	$Mass[$i]=$Mass[$i]+0.11;
   }
    if ($name_now =~ "SAMI") {
	$Mass[$i]=$Mass[$i]+0.21;
	$Mass_gas_ssp[$i]=$Mass_gas_ssp[$i]+0.21;
    }
    $color[$i]=log10(abs($data[$ncolor]));
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($Mass_gas[$i]>4)&&($Mass_gas[$i]<13)&&($Mass_gas_ssp[$i]>4)&&($Mass_gas_ssp[$i]<13)&&($OH_t2[$i]>7.5)&&($OH_t2[$i]<9.5)&&($OH_pyqz[$i]>7.5)&&($OH_pyqz[$i]<9.5)) {
	$i++;
    }
}
        
print "I=$i\n";




my $pdl_Morph=pdl(@a_morph);
my $pdl_OH_t2=pdl(@OH_t2);
my $pdl_OH_pyqz=pdl(@OH_pyqz);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);
my $pdl_Mass_gas=pdl(@Mass_gas);
my $pdl_Mass_gas_ssp=pdl(@Mass_gas_ssp);

my $pdl_f_gas_N=10**($pdl_Mass_gas)/(10**($pdl_Mass_gas)+10**($pdl_Mass));
my $pdl_f_gas=$pdl_f_gas_N->log10;

$x_min1=-2.8;
$x_max1=-0.01;
#$y_min1=-4.5;
#$y_max1=2.5;
$y_min1=8.1;
$y_max1=9.4;
$label_S="12+log(O/H)";
$label_M="f#dgas#u";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";

#$pdl_f_gas_x=pdl(0..10)/10;
$log_pdl_f_gas_x=-2.5+3.5*pdl(0..50)/50;
$pdl_f_gas_x=10**($log_pdl_f_gas_x);


$inv_pdl_f_gas_x=1/$pdl_f_gas_x;
#$yield=0.0035;
#
$yield=0.0035;
#$yield=5.7e-4;
$f_x_N=($yield/12)*($inv_pdl_f_gas_x->log);
$f_x=12+$f_x_N->log10+0.08;#-0.08;
#$eta=1; $R=0.1;
$eta=1; $R=0.001;
$f_gas_mod=1+(1+$eta/(1-$R))*($inv_pdl_f_gas_x-1);
$f_y_x=(($yield)/(1+$eta/(1-$R)*$f_gas_mod->log10));
$y_x=6-$f_y_x->log10;

#print "$f_y_x,$y_x\n";

#$y_x=0*$pdl_f_gas_x+12+log10($yield/12)+0.08;

#yprint "$pdl_f_gas_x\n $f_x\n";


$plot_file="plf_gas_OH".$pldev_suf; #$dev="pdfcairo";
my $NX=70;
my $NY=70;

my ($pdl_f_gas_IN,$pdl_OH_t2_IN,$pdl_OH_pyqz_IN,$pdl_color_IN,$pdl_Morph_IN)=where($pdl_f_gas,$pdl_OH_t2,$pdl_OH_pyqz,$pdl_color,$pdl_Morph,$pdl_Morph>-1);
my ($pdl_f_gas_Morph0,$pdl_OH_t2_Morph0,$pdl_OH_pyqz_Morph0,$pdl_color_Morph0)=where($pdl_f_gas_IN,$pdl_OH_t2_IN,$pdl_OH_pyqz_IN,$pdl_color_IN,$pdl_Morph_IN<=9);
my ($pdl_f_gas_Morph2,$pdl_OH_t2_Morph2,$pdl_OH_pyqz_Morph2,$pdl_color_Morph2)=where($pdl_f_gas_IN,$pdl_OH_t2_IN,$pdl_OH_pyqz_IN,$pdl_color_IN,$pdl_Morph_IN>=14);
my ($pdl_f_gas_Morph1_0,$pdl_OH_t2_Morph1_0,$pdl_OH_pyqz_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_f_gas_IN,$pdl_OH_t2_IN,$pdl_OH_pyqz_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Morph_IN>9);
my ($pdl_f_gas_Morph1,$pdl_OH_t2_Morph1,$pdl_OH_pyqz_Morph1,$pdl_color_Morph1)=where($pdl_f_gas_Morph1_0,$pdl_OH_t2_Morph1_0,$pdl_OH_pyqz_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# M-OH t2
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas,$pdl_OH_t2,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"t2");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph0,$pdl_OH_t2_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);

plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph1,$pdl_OH_t2_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph2,$pdl_OH_t2_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



# M-OH pyqz
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcnst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas,$pdl_OH_pyqz,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"pyqz");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph0,$pdl_OH_pyqz_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph1,$pdl_OH_pyqz_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph2,$pdl_OH_pyqz_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();



#########################################################################
# fgas-OH by Morphology
#########################################################################


# Output file
print "#########################################################################\n";
print "N = $n | fgas-ZH\n";
my @color;
my @Mass;
my @ZH_LW;
my @ZH_MW;
my @a_morph;
my @Mass_gas;
my @Mass_gas_ssp;

$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $ZH_LW[$i]=$data[$n_ZH_LW_Re];
    $ZH_MW[$i]=$data[$n_ZH_MW_Re];
    $color[$i]=log10(abs($data[$ncolor]));

    $Mass_gas[$i]=$data[$n_Mass_gas];
    $Mass_gas_ssp[$i]=$data[$n_Mass_gas_ssp];
    if ($name_now =~ "manga") {
	$Mass[$i]=$Mass[$i]+0.11;
   }
    if ($name_now =~ "SAMI") {
	$Mass[$i]=$Mass[$i]+0.21;
	$Mass_gas_ssp[$i]=$Mass_gas_ssp[$i]+0.21;
    }
    $color[$i]=log10(abs($data[$ncolor]));
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($Mass_gas[$i]>4)&&($Mass_gas[$i]<13)&&($Mass_gas_ssp[$i]>4)&&($Mass_gas_ssp[$i]<13)&&($ZH_LW[$i]>-1.5)&&($ZH_LW[$i]<0.5)&&($ZH_MW[$i]>-1.5)&&($ZH_MW[$i]<0.5)) {
	$i++;
    }
}
        
print "I=$i\n";




my $pdl_Morph=pdl(@a_morph);
my $pdl_ZH_LW=pdl(@ZH_LW);
my $pdl_ZH_MW=pdl(@ZH_MW);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);
my $pdl_Mass_gas=pdl(@Mass_gas);
my $pdl_Mass_gas_ssp=pdl(@Mass_gas_ssp);

my $pdl_f_gas_N=10**($pdl_Mass_gas)/(10**($pdl_Mass_gas)+10**($pdl_Mass));
my $pdl_f_gas=$pdl_f_gas_N->log10;

$x_min1=-2.8;
$x_max1=-0.01;
$y_min1=-0.8;
$y_max1=0.3;
$label_S="[Z/H]";
$label_M="f#dgas#u";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";

#$pdl_f_gas_x=pdl(0..10)/10;
$log_pdl_f_gas_x=-2.5+3.5*pdl(0..50)/50;
$pdl_f_gas_x=10**($log_pdl_f_gas_x);


$inv_pdl_f_gas_x=1/$pdl_f_gas_x;
#$yield=0.0035;
$yield=0.0035;
$f_x_N=($yield/12)*($inv_pdl_f_gas_x->log);
$f_x=12+$f_x_N->log10-8.79-0.3;#-0.08;
$y_x=$y_x-8.79-0.3;

#$y_x=0*$pdl_f_gas_x+12+log10($yield/12)+0.08-8.79;

#yprint "$pdl_f_gas_x\n $f_x\n";


$plot_file="plf_gas_ZH".$pldev_suf; #$dev="pdfcairo";
my $NX=70;
my $NY=70;

my ($pdl_f_gas_IN,$pdl_ZH_LW_IN,$pdl_ZH_MW_IN,$pdl_color_IN,$pdl_Morph_IN)=where($pdl_f_gas,$pdl_ZH_LW,$pdl_ZH_MW,$pdl_color,$pdl_Morph,$pdl_Morph>-1);
my ($pdl_f_gas_Morph0,$pdl_ZH_LW_Morph0,$pdl_ZH_MW_Morph0,$pdl_color_Morph0)=where($pdl_f_gas_IN,$pdl_ZH_LW_IN,$pdl_ZH_MW_IN,$pdl_color_IN,$pdl_Morph_IN<=9);
my ($pdl_f_gas_Morph2,$pdl_ZH_LW_Morph2,$pdl_ZH_MW_Morph2,$pdl_color_Morph2)=where($pdl_f_gas_IN,$pdl_ZH_LW_IN,$pdl_ZH_MW_IN,$pdl_color_IN,$pdl_Morph_IN>=14);
my ($pdl_f_gas_Morph1_0,$pdl_ZH_LW_Morph1_0,$pdl_ZH_MW_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_f_gas_IN,$pdl_ZH_LW_IN,$pdl_ZH_MW_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Morph_IN>9);
my ($pdl_f_gas_Morph1,$pdl_ZH_LW_Morph1,$pdl_ZH_MW_Morph1,$pdl_color_Morph1)=where($pdl_f_gas_Morph1_0,$pdl_ZH_LW_Morph1_0,$pdl_ZH_MW_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# M-OH t2
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas,$pdl_ZH_LW,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"LW");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph0,$pdl_ZH_LW_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);

plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph1,$pdl_ZH_LW_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph2,$pdl_ZH_LW_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



# M-OH pyqz
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcnst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas,$pdl_ZH_MW,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"MW");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph0,$pdl_ZH_MW_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph1,$pdl_ZH_MW_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "lbcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_f_gas_Morph2,$pdl_ZH_MW_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
plline($log_pdl_f_gas_x,$f_x); plcol0(200); pllsty(3); plline($log_pdl_f_gas_x,$y_x);
#pllsty(2);
#plline($log_pdl_f_gas_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();



#########################################################################
# lambda-ellip by Morphology
#########################################################################


# Output file
print "#########################################################################\n";
print "N = $n | lambda-ellip\n";
my @color;
my @Mass;
my @elip_ab;
my @lambda_Re;
my @rat_vel_sigma;
my @a_morph;

$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $lambda_Re[$i]=$data[$n_lambda_Re];
    $rat_vel_sigma[$i]=$data[$n_rat_vel_sigma];
    $elip_ab[$i]=$data[$n_elip_ab];
    $color[$i]=log10(abs($data[$ncolor]));

    $Mass_gas[$i]=$data[$n_Mass_gas];
    $Mass_gas_ssp[$i]=$data[$n_Mass_gas_ssp];
    if ($name_now =~ "manga") {
	$Mass[$i]=$Mass[$i]+0.11;
   }
    if ($name_now =~ "SAMI") {
	$Mass[$i]=$Mass[$i]+0.21;
	$Mass_gas_ssp[$i]=$Mass_gas_ssp[$i]+0.21;
    }
    $color[$i]=log10(abs($data[$ncolor]));
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($lambda_Re[$i]>0.01)&&($lambda_Re[$i]<1.2)&&($rat_vel_sigma[$i]>0.01)&&($rat_vel_sigma[$i]<1.2)) {
	$i++;
    }
}
        
print "I=$i\n";




my $pdl_Morph=pdl(@a_morph);
my $pdl_elip_ab=pdl(@elip_ab);
my $pdl_lambda_Re=pdl(@lambda_Re);
my $pdl_rat_vel_sigma=pdl(@rat_vel_sigma);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);
#my $pdl_Mass_gas=pdl(@Mass_gas);
#my $pdl_Mass_gas_ssp=pdl(@Mass_gas_ssp);

#my $pdl_f_gas_N=10**($pdl_Mass_gas)/(10**($pdl_Mass_gas)+10**($pdl_Mass));
#my $pdl_f_gas=$pdl_f_gas_N->log10;

$x_min1=0;
$x_max1=0.95;
$y_min1=0.01;
$y_max1=1.0;
$label_S="";
$label_M="#ge";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";



$plot_file="pl_lambda_elip".$pldev_suf; #$dev="pdfcairo";
my $NX=40;
my $NY=40;

my ($pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN)=where($pdl_elip_ab,$pdl_lambda_Re,$pdl_rat_vel_sigma,$pdl_color,$pdl_Morph,$pdl_Morph>-1);
my ($pdl_elip_ab_Morph0,$pdl_lambda_Re_Morph0,$pdl_rat_vel_sigma_Morph0,$pdl_color_Morph0)=where($pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN<=9);
my ($pdl_elip_ab_Morph2,$pdl_lambda_Re_Morph2,$pdl_rat_vel_sigma_Morph2,$pdl_color_Morph2)=where($pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN>=14);
my ($pdl_elip_ab_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_rat_vel_sigma_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Morph_IN>9);
my ($pdl_elip_ab_Morph1,$pdl_lambda_Re_Morph1,$pdl_rat_vel_sigma_Morph1,$pdl_color_Morph1)=where($pdl_elip_ab_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_rat_vel_sigma_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

#
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "bcst", "bcnstv");
pllab("","#gl (R<Re)","");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_elip_ab,$pdl_lambda_Re,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(250);
plwidth(2);
pllsty(2);
#plline($log_pdl_elip_ab_x,$f_x);
#pllsty(2);
##plline($log_pdl_elip_ab_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"ALL");
#plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"LW");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_elip_ab_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);

plcol0(250);
plwidth(2);
pllsty(2);
#plline($log_pdl_elip_ab_x,$f_x);
#pllsty(2);
##plline($log_pdl_elip_ab_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_elip_ab_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
#plline($log_pdl_elip_ab_x,$f_x);
#pllsty(2);
##plline($log_pdl_elip_ab_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_elip_ab_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
#plline($log_pdl_elip_ab_x,$f_x);
#pllsty(2);
##plline($log_pdl_elip_ab_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



#
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "bcnst", "bcnstv");
pllab("","v/#gs (R<Re)","");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_elip_ab,$pdl_rat_vel_sigma,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
#plline($log_pdl_elip_ab_x,$f_x);
#pllsty(2);
##plline($log_pdl_elip_ab_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"ALL");
#plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"MW");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_elip_ab_Morph0,$pdl_rat_vel_sigma_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
#plline($log_pdl_elip_ab_x,$f_x);
#pllsty(2);
##plline($log_pdl_elip_ab_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_elip_ab_Morph1,$pdl_rat_vel_sigma_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
#plline($log_pdl_elip_ab_x,$f_x);
#pllsty(2);
##plline($log_pdl_elip_ab_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.5, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_elip_ab_Morph2,$pdl_rat_vel_sigma_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
plcol0(250);
plwidth(2);
pllsty(2);
#plline($log_pdl_elip_ab_x,$f_x);
#pllsty(2);
##plline($log_pdl_elip_ab_x,$y_x);
pllsty(1);
plcol0(0);
plwidth(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();





print "#########################################################################\n";
print "N = $n | lambda-ellip Mass\n";
my @color;
my @Mass;
my @elip_ab;
my @lambda_Re;
my @rat_vel_sigma;
my @a_morph;

$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $lambda_Re[$i]=$data[$n_lambda_Re];
    $rat_vel_sigma[$i]=$data[$n_rat_vel_sigma];
    $elip_ab[$i]=$data[$n_elip_ab];
    $color[$i]=log10(abs($data[$ncolor]));

    $Mass_gas[$i]=$data[$n_Mass_gas];
    $Mass_gas_ssp[$i]=$data[$n_Mass_gas_ssp];
    if ($name_now =~ "manga") {
	$Mass[$i]=$Mass[$i]+0.11;
   }
    if ($name_now =~ "SAMI") {
	$Mass[$i]=$Mass[$i]+0.21;
	$Mass_gas_ssp[$i]=$Mass_gas_ssp[$i]+0.21;
    }
    $color[$i]=log10(abs($data[$ncolor]));
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($lambda_Re[$i]>0.01)&&($lambda_Re[$i]<1.2)&&($rat_vel_sigma[$i]>0.01)&&($rat_vel_sigma[$i]<1.2)) {
	$i++;
    }
}
        
print "I=$i\n";




my $pdl_Morph=pdl(@a_morph);
my $pdl_elip_ab=pdl(@elip_ab);
my $pdl_lambda_Re=pdl(@lambda_Re);
my $pdl_rat_vel_sigma=pdl(@rat_vel_sigma);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);


$x_min1=0.01;
$x_max1=0.99;
$y_min1=0.01;
$y_max1=0.99;
$label_S="#gl (R<Re)";
$label_M="#ge";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";



$plot_file="pl_lambda_elip_mass".$pldev_suf; #$dev="pdfcairo";
my $NX=35;
my $NY=35;

my ($pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Mass_IN)=where($pdl_elip_ab,$pdl_lambda_Re,$pdl_rat_vel_sigma,$pdl_color,$pdl_Morph,$pdl_Mass,$pdl_Morph>-1);
my ($pdl_elip_ab_Morph0,$pdl_lambda_Re_Morph0,$pdl_rat_vel_sigma_Morph0,$pdl_color_Morph0,$pdl_Mass_Morph2)=where($pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Mass_IN,$pdl_Morph_IN<=9);
my ($pdl_elip_ab_Morph2,$pdl_lambda_Re_Morph2,$pdl_rat_vel_sigma_Morph2,$pdl_color_Morph2,$pdl_Mass_Morph2)=where($pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Mass_IN,$pdl_Morph_IN>=14);
my ($pdl_elip_ab_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_rat_vel_sigma_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0,$pdl_Mass_Morph1_0)=where($pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Mass_IN,$pdl_Morph_IN>9);
my ($pdl_elip_ab_Morph1,$pdl_lambda_Re_Morph1,$pdl_rat_vel_sigma_Morph1,$pdl_color_Morph1,$pdl_Mass_Morph1)=where($pdl_elip_ab_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_rat_vel_sigma_Morph1_0,$pdl_color_Morph1_0,$pdl_Mass_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;


plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);


my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 800;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);


#
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcnstv");
$symbol=0;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_elip_ab,$pdl_lambda_Re,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"ALL");
#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_elip_ab,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_elip_ab_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"E/S0");
#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_elip_ab,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_elip_ab_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"Sa/Sb");

#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_elip_ab,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_elip_ab_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"Sc/Sd");

#plend();
#print "PASO\n";


@Mass_limit=(7,9.5,10.5,11,13.5);

for (my $I=0;$I<$#Mass_limit;$I++) {
    my $min_M=$Mass_limit[$I];
    my $max_M=$Mass_limit[$I+1];
    my $y1_view=0.10+0.17*($I+1);
    my $y0_view=0.10+0.17*($I);
#my ($pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Mass_IN)=where($pdl_elip_ab,$pdl_lambda_Re,$pdl_rat_vel_sigma,$pdl_color,$pdl_Morph,$pdl_Mass,$pdl_Morph>-1);    
my ($pdl_Mass_Mass0,$pdl_elip_ab_Mass0,$pdl_lambda_Re_Mass0,$pdl_color_Mass0,$pdl_Morph_Mass0)=where($pdl_Mass_IN,$pdl_elip_ab_IN,$pdl_lambda_Re_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Mass_IN>$min_M);
my ($pdl_Mass_Mass,$pdl_elip_ab_Mass,$pdl_lambda_Re_Mass,$pdl_color_Mass,$pdl_Morph_Mass)=where($pdl_Mass_Mass0,$pdl_elip_ab_Mass0,$pdl_lambda_Re_Mass0,$pdl_color_Mass0,$pdl_Morph_Mass0,$pdl_Mass_Mass0<$max_M);

my ($pdl_Mass_Morph0,$pdl_elip_ab_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0)=where($pdl_Mass_Mass,$pdl_elip_ab_Mass,$pdl_lambda_Re_Mass,$pdl_color_Mass,$pdl_Morph_Mass<=9);
my ($pdl_Mass_Morph2,$pdl_elip_ab_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2)=where($pdl_Mass_Mass,$pdl_elip_ab_Mass,$pdl_lambda_Re_Mass,$pdl_color_Mass,$pdl_Morph_Mass>=14);
my ($pdl_Mass_Morph1_0,$pdl_elip_ab_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_Mass,$pdl_elip_ab,$pdl_lambda_Re,$pdl_color,$pdl_Morph_Mass,$pdl_Morph_Mass>9);
my ($pdl_Mass_Morph1,$pdl_elip_ab_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1)=where($pdl_Mass_Morph1_0,$pdl_elip_ab_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
my @dims=$pdl_Mass_Mass->dims();
print "$min_M<M<$max_M #=@dims\n";
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (0.25, 0.1, 0.3, 0.1, "bcnst", "bcnstv");
    } else {
	plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcnstv");
    }
$symbol=0;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_elip_ab_Mass,$pdl_lambda_Re_Mass,$pdl_color_Mass,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
my $label_now="".$min_M."-".$max_M."";
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,$label_now);


#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (0.25, 0.1, 0.3, 0.1, "bcnst", "bcstv");
    } else {
	plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcstv");
    }
#plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcstv");
$symbol=0;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_elip_ab_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
    #plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"E/S0");
#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (0.25, 0.1, 0.3, 0.1, "bcnst", "bcstv");
    } else {
	plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcstv");
    }
#plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_elip_ab,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_elip_ab_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
#plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"Sa/Sb");

#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (0.25, 0.1, 0.3, 0.1, "bcnst", "bcstv");
    } else {
	plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcstv");
    }
#plbox (0.25, 0.1, 0.3, 0.1, "bcst", "bcstv");
$symbol=0;
#plscatter($pdl_elip_ab,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_elip_ab_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
#plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"Sc/Sd");

}

######################

#READ_cmap_plplot1_r("/home/sanchez/sda2/code/colortables/magma.csv",0.7);
READ_cmap_plplot1_r($pl_colormap1,0.7);
#my @stats=stats($pdl_color);
#my $zmin=$stats[3];
#my $zmax=$stats[4];
plcol0(0);
plcolorbar(0.90, 0.93, 0.10, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-2);
plvpor (0.13, 0.895, 0.10, 0.95);
pllab($label_M,$label_S,"");

plend();

#####################################################################################
print "#########################################################################\n";
print "N = $n | M-Mdyn OLD\n";
my @color;
my @Mass;
my @Mass_dyn_rot;
my @Mass_dyn_SK;
my @a_morph;
$i=0;

#my @a_morph;
open(OUT,">ARAA_Mdyn.csv");
print OUT "# (1) name\n";
print OUT "# (2) M*\n";
print OUT "# (3) Mdyn_rot\n";
print OUT "# (4) Mdyn_disp\n";
print OUT "# (5) Mdyn_SK\n";
for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];

    $disp_now=$data[$n_disp_ssp_1Re];
    #$disp_now=$data[$n_disp_ssp_cen];
    
    $vel_now_ssp=$data[$n_vel_ssp_1Re];
    $vel_now_Ha=$data[$n_vel_Ha_1Re];

#    $vel_now_ssp=$data[$n_vel_ssp_2Re];
#    $vel_now_Ha=$data[$n_vel_Ha_2Re];


    $delta_vel=abs($vel_now_ssp-$vel_now_Ha);
    if ($delta_vel<30) {
	$vel_now=0.5*($vel_now_ssp+$vel_now_Ha);
    } else {
#	if ($vel_now_Ha>$vel_now_ssp) {
#	    $vel_now=$vel_now_Ha;
#	} else {
	    $vel_now=$vel_now_ssp;
#	}
    }

    
    $SK_now=sqrt(0.5*$vel_now**2+$disp_now**2);
    $Re_now=$data[$n_Re];
    $Re_now_arc=$data[$n_Re_arc];
    $FoV=$data[$n_FoV];
    $G=4.302*(1e-6);
    $eta=2.5;
    $Mass_dyn_rot[$i]=log10($eta*$Re_now*($vel_now**2)/$G);
    $Mass_dyn_disp[$i]=log10($Re_now*($disp_now**2)/$G);
    $Mass_dyn_SK[$i]=log10($eta*$Re_now*($SK_now**2)/$G);
    $elip_ab[$i]=$data[$n_elip_ab];
#    print "$Mass[$i],$Mass_dyn_rot[$i],$Mass_dyn_SK[$i],$vel_now,$disp_now,$SK_now\n";
    if ($name_now =~ "manga") {
	$Mass[$i]=$Mass[$i]+0.11;
#	$Mass_dyn_SK[$i]=$Mass_dyn_SK[$i]+0.2;
   }
    if ($name_now =~ "SAMI") {
	$Mass[$i]=$Mass[$i]+0.21;
	$Mass_dyn_SK[$i]=$Mass_dyn_SK[$i]+0.21;
    }
    $color[$i]=log10(abs($data[$ncolor]));
    #    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($Mass_dyn_rot[$i]>7.5)&&($Mass_dyn_rot[$i]<9.5)&&($Mass_dyn_SK[$i]>7.5)&&($Mass_dyn_SK[$i]<9.5)) {
#    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($Mass_dyn_rot[$i]>4)&&($Mass_dyn_rot[$i]<15)&&($Mass_dyn_SK[$i]>4)&&($Mass_dyn_SK[$i]<15)&&($name_now !~ "SAMI")) {
#    print "($Mass[$i]>6)&&($Mass[$i]<13)&&($a_morph[$i]>-1)&&($Mass_dyn_rot[$i]>7.5)&&($Mass_dyn_rot[$i]<9.5)&&($Mass_dyn_SK[$i]>7.5)&&($Mass_dyn_SK[$i]<9.5)\n";
	#    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($Mass_dyn_rot[$i]>4)&&($Mass_dyn_rot[$i]<15)&&($Mass_dyn_SK[$i]>4)&&($Mass_dyn_SK[$i]<15)&&($FoV>2)&&($FoV<20)&&($Re_now_arc>5)&&($Re_now_arc<60)&&(abs($Mass[$i]-$Mass_dyn_SK[$i])<5)&&($delta_vel<100)) {
	    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($Mass_dyn_rot[$i]>4)&&($Mass_dyn_rot[$i]<15)&&($Mass_dyn_SK[$i]>4)&&($Mass_dyn_SK[$i]<15)&&($FoV>2)&&($FoV<20)&&($Re_now_arc>5)&&($Re_now_arc<60)&&(abs($Mass[$i]-$Mass_dyn_SK[$i])<10)&&($elip_ab[$i]<0.9)&&($elip_ab[$i]>-1)&&($a_morph[$i]<17)) {
		$Mass_dyn_rot{$name_now}=$Mass_dyn_rot[$i];
		$Mass_dyn_disp{$name_now}=$Mass_dyn_disp[$i];
		$Mass_dyn_SK{$name_now}=$Mass_dyn_SK[$i];
		print OUT "$name_now,$Mass[$i],$Mass_dyn_rot[$i],$Mass_dyn_disp[$i],$Mass_dyn_SK[$i]\n";
	$i++;
    }
}
     
close(OUT);   
print "I=$i\n";




my $pdl_Morph=pdl(@a_morph);
my $pdl_Mass_dyn_rot=pdl(@Mass_dyn_rot);
my $pdl_Mass_dyn_disp=pdl(@Mass_dyn_disp);
my $pdl_Mass_dyn_SK=pdl(@Mass_dyn_SK);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);


$x_min1=7.5;
$x_max1=12.3;
#$y_min1=-4.5;
#$y_max1=2.5;
$y_min1=7.7;
$y_max1=13.5;

#$label_S="log(M#d*#u/M#dgas,Av#u)";
$label_S="log(M#ddyn#u/M#d#[0x2299]#u)";
$label_M="log(M#d*#u/M#d#[0x2299]#u)";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";

$pdl_line_x=$x_min1+($x_max1-$x_min1)*pdl(0..100)/100;



$plot_file="plM_Mdyn".$pldev_suf; #$dev="pdfcairo";
my $NX=50;
my $NY=50;

my ($pdl_Mass_IN,$pdl_Mass_dyn_rot_IN,$pdl_Mass_dyn_SK_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Mass_dyn_disp_IN)=where($pdl_Mass,$pdl_Mass_dyn_rot,$pdl_Mass_dyn_SK,$pdl_color,$pdl_Morph,$pdl_Mass_dyn_disp,$pdl_Morph>-1);
my ($pdl_Mass_Morph0,$pdl_Mass_dyn_rot_Morph0,$pdl_Mass_dyn_SK_Morph0,$pdl_color_Morph0,$pdl_Mass_dyn_disp_Morph0)=where($pdl_Mass_IN,$pdl_Mass_dyn_rot_IN,$pdl_Mass_dyn_SK_IN,$pdl_color_IN,$pdl_Mass_dyn_disp_IN,$pdl_Morph_IN<=9);
my ($pdl_Mass_Morph2,$pdl_Mass_dyn_rot_Morph2,$pdl_Mass_dyn_SK_Morph2,$pdl_color_Morph2,$pdl_Mass_dyn_disp_Morph2)=where($pdl_Mass_IN,$pdl_Mass_dyn_rot_IN,$pdl_Mass_dyn_SK_IN,$pdl_color_IN,$pdl_Mass_dyn_disp_IN,$pdl_Morph_IN>=14);
my ($pdl_Mass_Morph1_0,$pdl_Mass_dyn_rot_Morph1_0,$pdl_Mass_dyn_SK_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0,$pdl_Mass_dyn_disp_Morph1_0)=where($pdl_Mass_IN,$pdl_Mass_dyn_rot_IN,$pdl_Mass_dyn_SK_IN,$pdl_color_IN,$pdl_Morph_IN,,$pdl_Mass_dyn_disp_IN,$pdl_Morph_IN>9);
my ($pdl_Mass_Morph1,$pdl_Mass_dyn_rot_Morph1,$pdl_Mass_dyn_SK_Morph1,$pdl_color_Morph1,$pdl_Mass_dyn_disp_Morph1)=where($pdl_Mass_Morph1_0,$pdl_Mass_dyn_rot_Morph1_0,$pdl_Mass_dyn_SK_Morph1_0,$pdl_color_Morph1_0,,$pdl_Mass_dyn_disp_Morph1_0,$pdl_Morph1_0<14);


#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 400;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# M-OH t2
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_Mass_dyn_rot,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(2);
plline($pdl_line_x,$pdl_line_x);

pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.25*($y_max1-$y_min1),0,0,0,"V#drot");
#plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Av,gas");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_Mass_dyn_rot_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(2);
plline($pdl_line_x,$pdl_line_x);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_Mass_dyn_rot_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(2);
plline($pdl_line_x,$pdl_line_x);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.55, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_Mass_dyn_rot_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(2);
plline($pdl_line_x,$pdl_line_x);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");



# M-OH pyqz
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass,$pdl_Mass_dyn_SK,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(2);
plline($pdl_line_x,$pdl_line_x);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.25*($y_max1-$y_min1),0,0,0,"SK");
#plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"Av,ssp");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph0,$pdl_Mass_dyn_SK_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(2);
plline($pdl_line_x,$pdl_line_x);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph1,$pdl_Mass_dyn_SK_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(2);
plline($pdl_line_x,$pdl_line_x);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.15, 0.55);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (1.0, 0.25, 1.0, 0.25, "bcnst", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_Mass_Morph2,$pdl_Mass_dyn_SK_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(2);
plline($pdl_line_x,$pdl_line_x);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");

#0.695, 0.895,



#########################################################################
READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.15, 0.95);
pllab($label_M,$label_S,"");

plend();




print "#########################################################################\n";
print "N = $n | lambda-f_gas Mass\n";
my @color;
my @Mass;
my @elip_ab;
my @lambda_Re;
my @rat_vel_sigma;
my @a_morph;
my @Mass_gas;
my @Mass_gas_ssp;

$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $lambda_Re[$i]=$data[$n_lambda_Re];
    $rat_vel_sigma[$i]=$data[$n_rat_vel_sigma];
    $elip_ab[$i]=$data[$n_elip_ab];
    $color[$i]=log10(abs($data[$ncolor]));

    $Mass_gas[$i]=$data[$n_Mass_gas];
    $Mass_gas_ssp[$i]=$data[$n_Mass_gas_ssp];
    if ($name_now =~ "manga") {
	$Mass[$i]=$Mass[$i]+0.11;
   }
    if ($name_now =~ "SAMI") {
	$Mass[$i]=$Mass[$i]+0.21;
	$Mass_gas_ssp[$i]=$Mass_gas_ssp[$i]+0.21;
    }
    $color[$i]=log10(abs($data[$ncolor]));
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($lambda_Re[$i]>0.01)&&($lambda_Re[$i]<1.2)&&($rat_vel_sigma[$i]>0.01)&&($rat_vel_sigma[$i]<1.2)) {
	$i++;
    }
}
        
print "I=$i\n";




my $pdl_Morph=pdl(@a_morph);
my $pdl_elip_ab=pdl(@elip_ab);
my $pdl_lambda_Re=pdl(@lambda_Re);
my $pdl_rat_vel_sigma=pdl(@rat_vel_sigma);
my $pdl_Mass=pdl(@Mass);
my $pdl_color=pdl(@color);
my $pdl_Mass_gas_ssp=pdl(@Mass_gas_ssp);
my $pdl_Mass_gas=pdl(@Mass_gas);
my $pdl_f_gas_N=10**($pdl_Mass_gas)/(10**($pdl_Mass_gas)+10**($pdl_Mass));
my $pdl_f_gas=$pdl_f_gas_N->log10;

$x_min1=-2.8;
$x_max1=-0.01;
$y_min1=0.01;
$y_max1=0.99;
$label_S="#gl (R<Re)";
$label_M="f#dgas#u";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";



$plot_file="pl_lambda_f_gas_mass".$pldev_suf; #$dev="pdfcairo";
my $NX=35;
my $NY=35;

my ($pdl_f_gas_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Mass_IN)=where($pdl_f_gas,$pdl_lambda_Re,$pdl_rat_vel_sigma,$pdl_color,$pdl_Morph,$pdl_Mass,$pdl_Morph>-1);
my ($pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_rat_vel_sigma_Morph0,$pdl_color_Morph0,$pdl_Mass_Morph2)=where($pdl_f_gas_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Mass_IN,$pdl_Morph_IN<=9);
my ($pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_rat_vel_sigma_Morph2,$pdl_color_Morph2,$pdl_Mass_Morph2)=where($pdl_f_gas_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Mass_IN,$pdl_Morph_IN>=14);
my ($pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_rat_vel_sigma_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0,$pdl_Mass_Morph1_0)=where($pdl_f_gas_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Mass_IN,$pdl_Morph_IN>9);
my ($pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_rat_vel_sigma_Morph1,$pdl_color_Morph1,$pdl_Mass_Morph1)=where($pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_rat_vel_sigma_Morph1_0,$pdl_color_Morph1_0,$pdl_Mass_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;


plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);


my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 800;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);


#
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcnstv");
$symbol=0;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_f_gas,$pdl_lambda_Re,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"ALL");
#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcstv");
$symbol=0;
#plscatter($pdl_f_gas,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"E/S0");
#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcstv");
$symbol=0;
#plscatter($pdl_f_gas,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"Sa/Sb");

#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcstv");
$symbol=0;
#plscatter($pdl_f_gas,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"Sc/Sd");

#plend();
#print "PASO\n";


@Mass_limit=(7,9.5,10.5,11,13.5);

for (my $I=0;$I<$#Mass_limit;$I++) {
    my $min_M=$Mass_limit[$I];
    my $max_M=$Mass_limit[$I+1];
    my $y1_view=0.10+0.17*($I+1);
    my $y0_view=0.10+0.17*($I);
#my ($pdl_f_gas_IN,$pdl_lambda_Re_IN,$pdl_rat_vel_sigma_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Mass_IN)=where($pdl_f_gas,$pdl_lambda_Re,$pdl_rat_vel_sigma,$pdl_color,$pdl_Morph,$pdl_Mass,$pdl_Morph>-1);    
my ($pdl_Mass_Mass0,$pdl_f_gas_Mass0,$pdl_lambda_Re_Mass0,$pdl_color_Mass0,$pdl_Morph_Mass0)=where($pdl_Mass_IN,$pdl_f_gas_IN,$pdl_lambda_Re_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Mass_IN>$min_M);
my ($pdl_Mass_Mass,$pdl_f_gas_Mass,$pdl_lambda_Re_Mass,$pdl_color_Mass,$pdl_Morph_Mass)=where($pdl_Mass_Mass0,$pdl_f_gas_Mass0,$pdl_lambda_Re_Mass0,$pdl_color_Mass0,$pdl_Morph_Mass0,$pdl_Mass_Mass0<$max_M);

my ($pdl_Mass_Morph0,$pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0)=where($pdl_Mass_Mass,$pdl_f_gas_Mass,$pdl_lambda_Re_Mass,$pdl_color_Mass,$pdl_Morph_Mass<=9);
my ($pdl_Mass_Morph2,$pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2)=where($pdl_Mass_Mass,$pdl_f_gas_Mass,$pdl_lambda_Re_Mass,$pdl_color_Mass,$pdl_Morph_Mass>=14);
my ($pdl_Mass_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_Mass,$pdl_f_gas,$pdl_lambda_Re,$pdl_color,$pdl_Morph_Mass,$pdl_Morph_Mass>9);
my ($pdl_Mass_Morph1,$pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1)=where($pdl_Mass_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
my @dims=$pdl_Mass_Mass->dims();
print "$min_M<M<$max_M #=@dims\n";
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (0.25, 0.1, 0.3, 0.1, "lbcnst", "bcnstv");
    } else {
	plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcnstv");
    }
$symbol=0;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_f_gas_Mass,$pdl_lambda_Re_Mass,$pdl_color_Mass,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
my $label_now="".$min_M."-".$max_M."";
plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,$label_now);


#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (0.25, 0.1, 0.3, 0.1, "lbcnst", "bcstv");
    } else {
	plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcstv");
    }
#plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcstv");
$symbol=0;
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
    #plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"E/S0");
#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (0.25, 0.1, 0.3, 0.1, "lbcnst", "bcstv");
    } else {
	plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcstv");
    }
#plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcstv");
$symbol=0;
#plscatter($pdl_f_gas,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
#plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"Sa/Sb");

#
# Sa/Sab
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, $y0_view, $y1_view);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
    if ($I==0) {
	plbox (0.25, 0.1, 0.3, 0.1, "lbcnst", "bcstv");
    } else {
	plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcstv");
    }
#plbox (0.25, 0.1, 0.3, 0.1, "lbcst", "bcstv");
$symbol=0;
#plscatter($pdl_f_gas,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_BPT_NII,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
#plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
#plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
#plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);
#plcol0(0); plptex($x_max1-0.3*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0.5,"Sc/Sd");

}

######################

#READ_cmap_plplot1_r("/home/sanchez/sda2/code/colortables/magma.csv",0.7);
READ_cmap_plplot1_r($pl_colormap1,0.7);
#my @stats=stats($pdl_color);
#my $zmin=$stats[3];
#my $zmax=$stats[4];
plcol0(0);
plcolorbar(0.90, 0.93, 0.10, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-2);
plvpor (0.13, 0.895, 0.10, 0.95);
pllab($label_M,$label_S,"");



plend();






#########################################################################
# M-ZH by Morphology
#########################################################################


# Output file
print "#########################################################################\n";
print "N = $n | BR-ML\n";
my @color;
my @Mass;
my @ZH_LW;
my @ZH_MW;
my @a_morph;
$i=0;

#my @a_morph;

for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
    my @data_phot=split(",",$PHOTOMETRY{$name_now});
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

    $ncolor=$n_EW_Ha; # EW(Ha)    
    $a_morph[$i]=$A_MORPH[$j];
    $Mass[$i]=$data[$n_Mass];
    $ML[$i]=log10($data[$n_ML]);
    $ZH_LW[$i]=$data[$n_ZH_LW_Re];
    $ZH_MW[$i]=$data[$n_ZH_MW_Re];
    $color[$i]=log10(abs($data[$ncolor]));
    $BR[$i]=$data_phot[$n_gm_BR];

    
    if (($Mass[$i]>6)&&($Mass[$i]<13)&&($data[$n_ML]!=0)&&($BR[$i]!=0)&&($SAMPLE{$name_now} ne "SAMI")) {
	$i++;
    }
}
        
print "I=$i\n";




my $pdl_Morph=pdl(@a_morph);
my $pdl_ML=pdl(@ML);
my $pdl_ML=pdl(@ML);
my $pdl_BR=pdl(@BR);
my $pdl_color=pdl(@color);


$x_min1=0.01;
$x_max1=1.5;
$y_min1=-0.4;
$y_max1=1.4;
$label_M="B-R";
$label_S="log(M/L#dV#u)";

$pdl_color->inplace->clip($zmin,$zmax);


#$z_min=-0.49;
#$zmin=-1.49;
#$zmax=2.65;
print "ALL $zmin,$zmax\n";



$plot_file="plBR_ML".$pldev_suf; #$dev="pdfcairo";
my $NX=70;
my $NY=70;

my ($pdl_BR_IN,$pdl_ML_IN,$pdl_ML_IN,$pdl_color_IN,$pdl_Morph_IN)=where($pdl_BR,$pdl_ML,$pdl_ML,$pdl_color,$pdl_Morph,$pdl_Morph>-1);
my ($pdl_BR_Morph0,$pdl_ML_Morph0,$pdl_ML_Morph0,$pdl_color_Morph0)=where($pdl_BR_IN,$pdl_ML_IN,$pdl_ML_IN,$pdl_color_IN,$pdl_Morph_IN<=9);
my ($pdl_BR_Morph2,$pdl_ML_Morph2,$pdl_ML_Morph2,$pdl_color_Morph2)=where($pdl_BR_IN,$pdl_ML_IN,$pdl_ML_IN,$pdl_color_IN,$pdl_Morph_IN>=14);
my ($pdl_BR_Morph1_0,$pdl_ML_Morph1_0,$pdl_ML_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_BR_IN,$pdl_ML_IN,$pdl_ML_IN,$pdl_color_IN,$pdl_Morph_IN,$pdl_Morph_IN>9);
my ($pdl_BR_Morph1,$pdl_ML_Morph1,$pdl_ML_Morph1,$pdl_color_Morph1)=where($pdl_BR_Morph1_0,$pdl_ML_Morph1_0,$pdl_ML_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);
#$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 220;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
READ_cmap_plplot1_r($pl_colormap1,$alpha);
pladv(0);

# M-OH t2
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.095, 0.295, 0.17, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.5, 0.25, 0.5, 0.25, "bcsnt", "bcnstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_BR,$pdl_ML,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"ALL");
#lcol0(0); plptex($x_max1-0.25*($x_max1-$x_min1),$y_min1+0.1*($y_max1-$y_min1),0,0,0,"LW");

#
# E/S0
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.295, 0.495, 0.17, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.5, 0.25, 0.5, 0.25, "bcsnt", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_BR_Morph0,$pdl_ML_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"E/S0");

#
# Sa/Sb
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.495, 0.695, 0.17, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.5, 0.25, 0.5, 0.25, "bcsnt", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_BR_Morph1,$pdl_ML_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sa/Sb");

#
# Sc/Sd
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.695, 0.895, 0.17, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.5, 0.25, 0.5, 0.25, "bcsnt", "bcstv");
$symbol=0;
#print "$zmin,$zmax\n";
(my $pdl_den_SFMS,my $pdl_fden_SFMS, my $pdl_levels_SFMS)=density_map_XY($pdl_BR_Morph2,$pdl_ML_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
plimagefr($pdl_fden_SFMS,$x_min1,$x_max1,$y_min1,$y_max1,$zmin,$zmax,$zmin,$zmax,0,0);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_SFMS->at(10),$pdl_levels_SFMS->at(50),$pdl_levels_SFMS->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_SFMS, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
plcol0(0);
plwidth(2);
pllsty(1);
pllsty(1);
plwidth(1);
plcol0(0); plptex($x_min1+0.05*($x_max1-$x_min1),$y_max1-0.1*($y_max1-$y_min1),0,0,0,"Sc/Sd");


READ_cmap_plplot1_r($pl_colormap1,0.7);
plcol0(0);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-1);
plvpor (0.11, 0.895, 0.17, 0.95);
pllab($label_M,$label_S,"");

plend();

#########################################################################




exit;
#*******************************************************************************************************#
# END
#*******************************************************************************************************#


#########################################################################
# BPT diagram PLPLOT MORPH
#########################################################################
# Output file
print "N = $n\n";
my @x;
my @x_2;
my @x_3;
my @e_x;
my @e_x_2;
my @e_x_3;
my @y;
my @e_y;
my @color;
my @BR;
$i=0;


for ($j=0;$j<$n;$j++) {
    $name_now=$name[$j];
    my @data=split(",",$LINE_PROC_ELINES{$name_now});
#    print "$i,$name[$i],$name_now\n";
    if ($name_now =~ "manga") {
        def_tables_MaNGA();        
    } else {
        def_tables();    
    }

#
# Center
#    
#    $nc1=$n_NII_Ha; # NII]/Ha
#    $nc1_2=$n_SII_Ha; # SII]/Ha
#    $nc1_3=$n_OI_Ha; # OII]/Hb
#    $nc2=$n_OIII_Hb; # OIII]/Hb
#    $ncolor=$n_EW_Ha_cen; # EW(Ha)

#
# Re
#    
    $nc1=$n_NII_Ha_Re; # NII]/Ha
    $nc1_2=$n_SII_Ha_Re; # SII]/Ha
    $nc1_3=$n_OI_Ha_Re; # OII]/Hb
    $nc2=$n_OIII_Hb_Re; # OIII]/Hb
    $ncolor=$n_EW_Ha; # EW(Ha)    

if (($data[$nc1] ne "BAD")&&($data[$nc1_2] ne "BAD")&&($data[$nc1_3] ne "BAD")&&($data[$nc2] ne "BAD")&&($data[$ncolor] ne "BAD")&&($data[$nc1+1] ne "BAD")&&($data[$nc1_2+1] ne "BAD")&&($data[$nc1_3+1] ne "BAD")) {
        $x[$i]=$data[$nc1];
        $x_2[$i]=$data[$nc1_2];
        $x_3[$i]=$data[$nc1_3];
        $y[$i]=$data[$nc2];
        $e_x[$i]=$data[$nc1+1];
        $e_x_2[$i]=$data[$nc1_2+1];
        $e_x_3[$i]=$data[$nc1_3+1];
        $e_y[$i]=$data[$nc2+1];
        $color[$i]=log10(abs($data[$ncolor]));
	$a_morph[$i]=$A_MORPH[$j];
	$BR[$i]=$data[$n_BR];
#	print "$i,$BR[$i]\n";
    if (($color[$i]>-0.5)&&($e_x[$i]<3)) {
    $i++;
    }
}
        
}
print "I=$i\n";



my $pdl_Morph=pdl(@a_morph);
my $pdl_BR=pdl(@BR);
my $pdl_f_gas=pdl(@x);
my $pdl_f_gas_2=pdl(@x_2);
my $pdl_f_gas_3=pdl(@x_3);
my $pdl_lambda_Re=pdl(@y);
my $pdl_ex=pdl(@e_x);
my $pdl_ex_2=pdl(@e_x_2);
my $pdl_ex_3=pdl(@e_x_3);
my $pdl_ey=pdl(@e_y);
my $pdl_color=pdl(@color);
$pdl_f_gas->inplace->setbadtoval(-12);
$pdl_f_gas_2->inplace->setbadtoval(-12);
$pdl_f_gas_3->inplace->setbadtoval(-12);

@dims=$pdl_f_gas->dims();
print "DIM=@dims,$#x\n";

$pdl_lambda_Re->inplace->setbadtoval(-12);
$pdl_color->inplace->setbadtoval(-3);
$pdl_size=0.02+0.0*sqrt($pdl_ex**2+$pdl_ey**2);
$pdl_size_2=0.02+0.0*sqrt($pdl_ex_2**2+$pdl_ey**2);
$pdl_size_3=0.02+0.0*sqrt($pdl_ex_3**2+$pdl_ey**2);

$pdl_cut_x=-3+0.02*pdl(0..300);
$pdl_cut_y=-0.7+0.2-3.67*$pdl_cut_x;
$pdl_cut_y2=-1.7+0.5-3.67*$pdl_cut_x;
$pdl_cut_y3=0.61/($pdl_cut_x-0.05)+1.3;
$pdl_cut_y4=0.61/($pdl_cut_x-0.47)+1.19;
$pdl_cut_y3->inplace->clip(-2,1.1);
$pdl_cut_y4->inplace->clip(-2,1.1);
$pdl_cut_y3->inplace->setvaltobad(1.1);
$pdl_cut_y4->inplace->setvaltobad(1.1);
$pdl_cut_y_SII=0.61/($pdl_cut_x-0.3)+1.3;
$pdl_cut_y_SII=0.61/($pdl_cut_x-0.3)+1.3;
$pdl_cut_y_SII_AGNs=1.89*($pdl_cut_x)+0.76;
$pdl_cut_y_OI=0.73/(($pdl_cut_x+0.59))+1.33;#+1.10;
$pdl_cut_y_OI_AGNs=1.18*($pdl_cut_x)+1.30;
$pdl_cut_y_OIII_AGNs=1.14*($pdl_cut_x)+0.36;

$pdl_cut_y_SII->inplace->clip(-2,1.1);
$pdl_cut_y_OI->inplace->clip(-2,1.1);
$pdl_cut_y_SII->inplace->setvaltobad(1.1);
$pdl_cut_y_OI->inplace->setvaltobad(1.1);

$label1_1='log([NII]/H#ga';
$label1_2='log([SII]/H#ga)';
$label1_3='log([OI]/H#ga)';
$label2='log([OIII]/H#gb)';
$label_cb='log|EW(H#ga)|';

#$x_min1=-1.75;
#$x_max1=0.75;
#$y_min1=-1.6;
#$y_max1=1.6;

my $NX=30;
my $NY=30;

$plot_file="plBPT_morph".$pldev_suf; #$dev="pdfcairo";


my ($pdl_BR_Morph0,$pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_f_gas_2_Morph0,$pdl_f_gas_3_Morph0,$pdl_color_Morph0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph<=9);
my ($pdl_BR_Morph2,$pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_f_gas_2_Morph2,$pdl_f_gas_3_Morph2,$pdl_color_Morph2)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph>=14);
my ($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph,$pdl_Morph>9);
my ($pdl_BR_Morph1,$pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_f_gas_2_Morph1,$pdl_f_gas_3_Morph1,$pdl_color_Morph1)=where($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);



$alpha=0.5;
plsdev($pldev_name); plsfnam($plot_file); 
plscolbga(255,255,255,1);
my $xp1 = 100.;
my $yp1 = 100.;
my $xleng1 = 800;
my $yleng1 = 800;
my $xoff1 = 10;
my $yoff1 = 20;
plspage($xp1, $yp1, $xleng1, $yleng1, $xoff1, $yoff1);
plinit();
plsfci($fci[3]);
my $n_ang=6;
my $size=0.05;
READ_cmap_plplot0_r($pl_colormap0,$alpha0);
#READ_cmap_plplot0_r($pl_colormap0,1);
READ_cmap_plplot1_r($pl_colormap1,0.05);
pladv(0);

#
# All galaxies
#
plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.085, 0.355, 0.78, 0.95);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcnstv");
#plmtex(2.8,0,0,"l",$label2);
#pllab($label1_1,"","");
$symbol=0;
plscatter($pdl_f_gas,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_NII,my $pdl_fden_BPT_NII, my $pdl_levels_NII)=density_map_XY($pdl_f_gas,$pdl_lambda_Re,$pdl_color,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII->at(10),$pdl_levels_NII->at(50),$pdl_levels_NII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);

########
# E/S0/S0a
(my $pdl_den_BPT_NII_Morph0,my $pdl_fden_BPT_NII_Morph0, my $pdl_levels_NII_Morph0)=density_map_XY($pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph0->at(10),$pdl_levels_NII_Morph0->at(50),$pdl_levels_NII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_NII_Morph1,my $pdl_fden_BPT_NII_Morph1, my $pdl_levels_NII_Morph1)=density_map_XY($pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph1->at(10),$pdl_levels_NII_Morph1->at(50),$pdl_levels_NII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_NII_Morph2,my $pdl_fden_BPT_NII_Morph2, my $pdl_levels_NII_Morph2)=density_map_XY($pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph2->at(10),$pdl_levels_NII_Morph2->at(50),$pdl_levels_NII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######



plcol0(0);
plwidth(2);
pllsty(1);
##plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
##plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT SII
plvpor(0.355, 0.625, 0.78, 0.95);
plwind ($x_min1+0.4,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcstv");
#pllab($label1_2,"","");
$symbol=0;
plscatter($pdl_f_gas_2,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_SII,my $pdl_fden_BPT_SII, my $pdl_levels_SII)=density_map_XY($pdl_f_gas_2,$pdl_lambda_Re,$pdl_color,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.4)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
#@tr=($dx,0,$x_min1+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@tr=($dx,0,$x_min1+0.4+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@levels=($pdl_levels_SII->at(10),$pdl_levels_SII->at(50),$pdl_levels_SII->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_SII, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);

########
# E/S0/S0a
(my $pdl_den_BPT_SII_Morph0,my $pdl_fden_BPT_SII_Morph0, my $pdl_levels_SII_Morph0)=density_map_XY($pdl_f_gas_2_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph0->at(10),$pdl_levels_SII_Morph0->at(50),$pdl_levels_SII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_SII_Morph1,my $pdl_fden_BPT_SII_Morph1, my $pdl_levels_SII_Morph1)=density_map_XY($pdl_f_gas_2_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph1->at(10),$pdl_levels_SII_Morph1->at(50),$pdl_levels_SII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_SII_Morph2,my $pdl_fden_BPT_SII_Morph2, my $pdl_levels_SII_Morph2)=density_map_XY($pdl_f_gas_2_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph2->at(10),$pdl_levels_SII_Morph2->at(50),$pdl_levels_SII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######


plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_SII);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT OI
plvpor (0.625, 0.895, 0.78, 0.95);
plwind ($x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcstv");
#pllab($label1_3,"","");
$symbol=0;
$pdl_f_gas_3->inplace->setvaltobad(0);
plscatter($pdl_f_gas_3,$pdl_lambda_Re,$symbol,$size,$n_ang,$pdl_color,0,0,0);
(my $pdl_den_BPT_OI,my $pdl_fden_BPT_OI, my $pdl_levels_OI)=density_map_XY($pdl_f_gas_3,$pdl_lambda_Re,$pdl_color,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.2+1.1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1-1.1,0,$dy,$y_min1);
@levels=($pdl_levels_OI->at(10),$pdl_levels_OI->at(50),$pdl_levels_OI->at(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_OI, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);


########
# E/S0/S0a
(my $pdl_den_BPT_OI_Morph0,my $pdl_fden_BPT_OI_Morph0, my $pdl_levels_OI_Morph0)=density_map_XY($pdl_f_gas_3_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph0->at(10),$pdl_levels_OI_Morph0->at(50),$pdl_levels_OI_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_OI_Morph1,my $pdl_fden_BPT_OI_Morph1, my $pdl_levels_OI_Morph1)=density_map_XY($pdl_f_gas_3_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph1->at(10),$pdl_levels_OI_Morph1->at(50),$pdl_levels_OI_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_OI_Morph2,my $pdl_fden_BPT_OI_Morph2, my $pdl_levels_OI_Morph2)=density_map_XY($pdl_f_gas_3_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph2->at(10),$pdl_levels_OI_Morph2->at(50),$pdl_levels_OI_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######
plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_OI);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);
pllsty(1);
plwidth(1);



#
# BR 11-13.5
#
#
my ($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_Morph_BR0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph,$pdl_BR>11);
my ($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR)=where($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_Morph_BR0,$pdl_BR_BR0<13.5);
#
# We select the morphology
#
my ($pdl_BR_Morph0,$pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_f_gas_2_Morph0,$pdl_f_gas_3_Morph0,$pdl_color_Morph0)=where($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR<=9);
my ($pdl_BR_Morph2,$pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_f_gas_2_Morph2,$pdl_f_gas_3_Morph2,$pdl_color_Morph2)=where($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR>=14);
my ($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph,$pdl_Morph_BR>9);
my ($pdl_BR_Morph1,$pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_f_gas_2_Morph1,$pdl_f_gas_3_Morph1,$pdl_color_Morph1)=where($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);


my @dims=$pdl_BR_BR->dims();
print "11<M<13.5 #=@dims\n";

plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.085, 0.355, 0.61, 0.78);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcnstv");
#pllab($label1_1,"","");
#plmtex(2.8,0,0,"l",$label2);
$symbol=0;
plscatter($pdl_f_gas_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_NII_BR,my $pdl_fden_BPT_NII_BR, my $pdl_levels_NII_BR)=density_map_XY($pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_BR->at(10),$pdl_levels_NII_BR->at(50),$pdl_levels_NII_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
########
# E/S0/S0a
# No galaxies in this regime!
#print "$pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0\n";
(my $pdl_den_BPT_NII_Morph0,my $pdl_fden_BPT_NII_Morph0, my $pdl_levels_NII_Morph0)=density_map_XY($pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph0->at(10),$pdl_levels_NII_Morph0->at(50),$pdl_levels_NII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_NII_Morph1,my $pdl_fden_BPT_NII_Morph1, my $pdl_levels_NII_Morph1)=density_map_XY($pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph1->at(10),$pdl_levels_NII_Morph1->at(50),$pdl_levels_NII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_NII_Morph2,my $pdl_fden_BPT_NII_Morph2, my $pdl_levels_NII_Morph2)=density_map_XY($pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph2->at(10),$pdl_levels_NII_Morph2->at(50),$pdl_levels_NII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######



plcol0(0);
plwidth(2);
pllsty(1);
##plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
##plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT SII
plvpor(0.355, 0.625, 0.61, 0.78);
plwind ($x_min1+0.4,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcstv");
#pllab($label1_2,"","");
$symbol=0;
plscatter($pdl_f_gas_2_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_SII_BR,my $pdl_fden_BPT_SII_BR, my $pdl_levels_SII_BR)=density_map_XY($pdl_f_gas_2_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.4)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@levels=($pdl_levels_SII_BR->at(10),$pdl_levels_SII_BR->at(50),$pdl_levels_SII_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
########
# E/S0/S0a
(my $pdl_den_BPT_SII_Morph0,my $pdl_fden_BPT_SII_Morph0, my $pdl_levels_SII_Morph0)=density_map_XY($pdl_f_gas_2_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph0->at(10),$pdl_levels_SII_Morph0->at(50),$pdl_levels_SII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_SII_Morph1,my $pdl_fden_BPT_SII_Morph1, my $pdl_levels_SII_Morph1)=density_map_XY($pdl_f_gas_2_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph1->at(10),$pdl_levels_SII_Morph1->at(50),$pdl_levels_SII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_SII_Morph2,my $pdl_fden_BPT_SII_Morph2, my $pdl_levels_SII_Morph2)=density_map_XY($pdl_f_gas_2_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph2->at(10),$pdl_levels_SII_Morph2->at(50),$pdl_levels_SII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######
plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_SII);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT OI
plvpor (0.625, 0.895, 0.61, 0.78);
plwind ($x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcstv");
#pllab($label1_3,"","");
$symbol=0;
$pdl_f_gas_3->inplace->setvaltobad(0);
plscatter($pdl_f_gas_3_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_OI_BR,my $pdl_fden_BPT_OI_BR, my $pdl_levels_OI_BR)=density_map_XY($pdl_f_gas_3_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.2+1.1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1-1.1,0,$dy,$y_min1);
@levels=($pdl_levels_OI_BR->at(10),$pdl_levels_OI_BR->at(50),$pdl_levels_OI_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);

########
# E/S0/S0a
(my $pdl_den_BPT_OI_Morph0,my $pdl_fden_BPT_OI_Morph0, my $pdl_levels_OI_Morph0)=density_map_XY($pdl_f_gas_3_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph0->at(10),$pdl_levels_OI_Morph0->at(50),$pdl_levels_OI_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_OI_Morph1,my $pdl_fden_BPT_OI_Morph1, my $pdl_levels_OI_Morph1)=density_map_XY($pdl_f_gas_3_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph1->at(10),$pdl_levels_OI_Morph1->at(50),$pdl_levels_OI_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####

# Sbc/Sc/Sd
(my $pdl_den_BPT_OI_Morph2,my $pdl_fden_BPT_OI_Morph2, my $pdl_levels_OI_Morph2)=density_map_XY($pdl_f_gas_3_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph2->at(10),$pdl_levels_OI_Morph2->at(50),$pdl_levels_OI_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######

plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_OI);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);
pllsty(1);
plwidth(1);

######################

#
# BR 10.5-11
#
#
#my ($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_BR>10.5);
#my ($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR)=where($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_BR_BR0<=11);

my ($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_Morph_BR0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph,$pdl_BR>10.5);
my ($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR)=where($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_Morph_BR0,$pdl_BR_BR0<11);
my @dims=$pdl_BR_BR->dims();
print "10.5<M<11 #=@dims\n";
#
# We select the morphology
#
my ($pdl_BR_Morph0,$pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_f_gas_2_Morph0,$pdl_f_gas_3_Morph0,$pdl_color_Morph0)=where($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR<=9);
my ($pdl_BR_Morph2,$pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_f_gas_2_Morph2,$pdl_f_gas_3_Morph2,$pdl_color_Morph2)=where($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR>=14);
#print "pdl_f_gas_3_Morph2=$pdl_f_gas_3_Morph2\n"; <stdin>;
my ($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph,$pdl_Morph_BR>9);
my ($pdl_BR_Morph1,$pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_f_gas_2_Morph1,$pdl_f_gas_3_Morph1,$pdl_color_Morph1)=where($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);

plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.085, 0.355, 0.44, 0.61);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcnstv");
#pllab($label1_1,"","");
#plmtex(2.8,0,0,"l",$label2);
$symbol=0;
plscatter($pdl_f_gas_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_NII_BR,my $pdl_fden_BPT_NII_BR, my $pdl_levels_NII_BR)=density_map_XY($pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_BR->at(10),$pdl_levels_NII_BR->at(50),$pdl_levels_NII_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
########
# E/S0/S0a
(my $pdl_den_BPT_NII_Morph0,my $pdl_fden_BPT_NII_Morph0, my $pdl_levels_NII_Morph0)=density_map_XY($pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph0->at(10),$pdl_levels_NII_Morph0->at(50),$pdl_levels_NII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_NII_Morph1,my $pdl_fden_BPT_NII_Morph1, my $pdl_levels_NII_Morph1)=density_map_XY($pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph1->at(10),$pdl_levels_NII_Morph1->at(50),$pdl_levels_NII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_NII_Morph2,my $pdl_fden_BPT_NII_Morph2, my $pdl_levels_NII_Morph2)=density_map_XY($pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph2->at(10),$pdl_levels_NII_Morph2->at(50),$pdl_levels_NII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######




plcol0(0);
plwidth(2);
pllsty(1);
##plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
##plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT SII
plvpor(0.355, 0.625, 0.44, 0.61);
plwind ($x_min1+0.4,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcstv");
#pllab($label1_2,"","");
$symbol=0;
plscatter($pdl_f_gas_2_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_SII_BR,my $pdl_fden_BPT_SII_BR, my $pdl_levels_SII_BR)=density_map_XY($pdl_f_gas_2_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.4)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@levels=($pdl_levels_SII_BR->at(10),$pdl_levels_SII_BR->at(50),$pdl_levels_SII_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
########
# E/S0/S0a
(my $pdl_den_BPT_SII_Morph0,my $pdl_fden_BPT_SII_Morph0, my $pdl_levels_SII_Morph0)=density_map_XY($pdl_f_gas_2_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph0->at(10),$pdl_levels_SII_Morph0->at(50),$pdl_levels_SII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_SII_Morph1,my $pdl_fden_BPT_SII_Morph1, my $pdl_levels_SII_Morph1)=density_map_XY($pdl_f_gas_2_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph1->at(10),$pdl_levels_SII_Morph1->at(50),$pdl_levels_SII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_SII_Morph2,my $pdl_fden_BPT_SII_Morph2, my $pdl_levels_SII_Morph2)=density_map_XY($pdl_f_gas_2_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph2->at(10),$pdl_levels_SII_Morph2->at(50),$pdl_levels_SII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######

plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_SII);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT OI
plvpor (0.625, 0.895, 0.44, 0.61);
plwind ($x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcstv");
#pllab($label1_3,"","");
$symbol=0;
$pdl_f_gas_3->inplace->setvaltobad(0);
plscatter($pdl_f_gas_3_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_OI_BR,my $pdl_fden_BPT_OI_BR, my $pdl_levels_OI_BR)=density_map_XY($pdl_f_gas_3_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.2+1.1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1-1.1,0,$dy,$y_min1);
@levels=($pdl_levels_OI_BR->at(10),$pdl_levels_OI_BR->at(50),$pdl_levels_OI_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
########
# E/S0/S0a
(my $pdl_den_BPT_OI_Morph0,my $pdl_fden_BPT_OI_Morph0, my $pdl_levels_OI_Morph0)=density_map_XY($pdl_f_gas_3_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph0->at(10),$pdl_levels_OI_Morph0->at(50),$pdl_levels_OI_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_OI_Morph1,my $pdl_fden_BPT_OI_Morph1, my $pdl_levels_OI_Morph1)=density_map_XY($pdl_f_gas_3_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph1->at(10),$pdl_levels_OI_Morph1->at(50),$pdl_levels_OI_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_OI_Morph2,my $pdl_fden_BPT_OI_Morph2, my $pdl_levels_OI_Morph2)=density_map_XY($pdl_f_gas_3_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph2->at(10),$pdl_levels_OI_Morph2->at(50),$pdl_levels_OI_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#$pdl_den_BPT_OI_Morph2->wfits("junk.fits.gz");
#######

plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_OI);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);
pllsty(1);
plwidth(1);

######################

#
# BR 9.5-10.5
#
#
#my ($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_BR>9.5);
#my ($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR)=where($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_BR_BR0<=10.5);
#my @dims=$pdl_BR_BR->dims();
#print "9.5<M<10.5 #=@dims\n";

my ($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_Morph_BR0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph,$pdl_BR>9.5);
my ($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR)=where($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_Morph_BR0,$pdl_BR_BR0<10.5);
my @dims=$pdl_BR_BR->dims();
print "9.5<M<10.5 #=@dims\n";
#
# We select the morphology
#
my ($pdl_BR_Morph0,$pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_f_gas_2_Morph0,$pdl_f_gas_3_Morph0,$pdl_color_Morph0)=where($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR<=9);
my ($pdl_BR_Morph2,$pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_f_gas_2_Morph2,$pdl_f_gas_3_Morph2,$pdl_color_Morph2)=where($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR>=14);
my ($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph,$pdl_Morph_BR>9);
my ($pdl_BR_Morph1,$pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_f_gas_2_Morph1,$pdl_f_gas_3_Morph1,$pdl_color_Morph1)=where($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);


plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.085, 0.355, 0.27,0.44);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcnstv");
#pllab($label1_1,"","");
#plmtex(2.8,0,0,"l",$label2);
$symbol=0;
plscatter($pdl_f_gas_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_NII_BR,my $pdl_fden_BPT_NII_BR, my $pdl_levels_NII_BR)=density_map_XY($pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_BR->at(10),$pdl_levels_NII_BR->at(50),$pdl_levels_NII_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);

########
# E/S0/S0a
(my $pdl_den_BPT_NII_Morph0,my $pdl_fden_BPT_NII_Morph0, my $pdl_levels_NII_Morph0)=density_map_XY($pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph0->at(10),$pdl_levels_NII_Morph0->at(50),$pdl_levels_NII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_NII_Morph1,my $pdl_fden_BPT_NII_Morph1, my $pdl_levels_NII_Morph1)=density_map_XY($pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph1->at(10),$pdl_levels_NII_Morph1->at(50),$pdl_levels_NII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_NII_Morph2,my $pdl_fden_BPT_NII_Morph2, my $pdl_levels_NII_Morph2)=density_map_XY($pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph2->at(10),$pdl_levels_NII_Morph2->at(50),$pdl_levels_NII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######



plcol0(0);
plwidth(2);
pllsty(1);
##plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
##plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT SII
plvpor(0.355, 0.625, 0.27,0.44);
plwind ($x_min1+0.4,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcstv");
#pllab($label1_2,"","");
$symbol=0;
plscatter($pdl_f_gas_2_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_SII_BR,my $pdl_fden_BPT_SII_BR, my $pdl_levels_SII_BR)=density_map_XY($pdl_f_gas_2_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.4)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@levels=($pdl_levels_SII_BR->at(10),$pdl_levels_SII_BR->at(50),$pdl_levels_SII_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
########
# E/S0/S0a
(my $pdl_den_BPT_SII_Morph0,my $pdl_fden_BPT_SII_Morph0, my $pdl_levels_SII_Morph0)=density_map_XY($pdl_f_gas_2_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph0->at(10),$pdl_levels_SII_Morph0->at(50),$pdl_levels_SII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_SII_Morph1,my $pdl_fden_BPT_SII_Morph1, my $pdl_levels_SII_Morph1)=density_map_XY($pdl_f_gas_2_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph1->at(10),$pdl_levels_SII_Morph1->at(50),$pdl_levels_SII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_SII_Morph2,my $pdl_fden_BPT_SII_Morph2, my $pdl_levels_SII_Morph2)=density_map_XY($pdl_f_gas_2_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph2->at(10),$pdl_levels_SII_Morph2->at(50),$pdl_levels_SII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######

plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_SII);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT OI
plvpor (0.625, 0.895, 0.27,0.44);
plwind ($x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcst", "bcstv");
#pllab($label1_3,"","");
$symbol=0;
$pdl_f_gas_3->inplace->setvaltobad(0);
plscatter($pdl_f_gas_3_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_OI_BR,my $pdl_fden_BPT_OI_BR, my $pdl_levels_OI_BR)=density_map_XY($pdl_f_gas_3_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.2+1.1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1-1.1,0,$dy,$y_min1);
@levels=($pdl_levels_OI_BR->at(10),$pdl_levels_OI_BR->at(50),$pdl_levels_OI_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
########
# E/S0/S0a
(my $pdl_den_BPT_OI_Morph0,my $pdl_fden_BPT_OI_Morph0, my $pdl_levels_OI_Morph0)=density_map_XY($pdl_f_gas_3_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph0->at(10),$pdl_levels_OI_Morph0->at(50),$pdl_levels_OI_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_OI_Morph1,my $pdl_fden_BPT_OI_Morph1, my $pdl_levels_OI_Morph1)=density_map_XY($pdl_f_gas_3_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph1->at(10),$pdl_levels_OI_Morph1->at(50),$pdl_levels_OI_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_OI_Morph2,my $pdl_fden_BPT_OI_Morph2, my $pdl_levels_OI_Morph2)=density_map_XY($pdl_f_gas_3_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph2->at(10),$pdl_levels_OI_Morph2->at(50),$pdl_levels_OI_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######

plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_OI);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);
pllsty(1);
plwidth(1);

######################



#
# BR 7-9.5
#
#
#my ($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_BR>7);
#my ($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR)=where($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_BR_BR0<=9.5);
#my @dims=$pdl_BR_BR->dims();
#print "7<M<9.5 #=@dims\n";

my ($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_Morph_BR0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph,$pdl_BR>7);
my ($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR)=where($pdl_BR_BR0,$pdl_f_gas_BR0,$pdl_lambda_Re_BR0,$pdl_f_gas_2_BR0,$pdl_f_gas_3_BR0,$pdl_color_BR0,$pdl_Morph_BR0,$pdl_BR_BR0<9.5);
my @dims=$pdl_BR_BR->dims();
print "7<M<9.5 #=@dims\n";
#
# We select the morphology
#
my ($pdl_BR_Morph0,$pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_f_gas_2_Morph0,$pdl_f_gas_3_Morph0,$pdl_color_Morph0)=where($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR<=9);
my ($pdl_BR_Morph2,$pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_f_gas_2_Morph2,$pdl_f_gas_3_Morph2,$pdl_color_Morph2)=where($pdl_BR_BR,$pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_f_gas_2_BR,$pdl_f_gas_3_BR,$pdl_color_BR,$pdl_Morph_BR>=14);
my ($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0)=where($pdl_BR,$pdl_f_gas,$pdl_lambda_Re,$pdl_f_gas_2,$pdl_f_gas_3,$pdl_color,$pdl_Morph,$pdl_Morph_BR>9);
my ($pdl_BR_Morph1,$pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_f_gas_2_Morph1,$pdl_f_gas_3_Morph1,$pdl_color_Morph1)=where($pdl_BR_Morph1_0,$pdl_f_gas_Morph1_0,$pdl_lambda_Re_Morph1_0,$pdl_f_gas_2_Morph1_0,$pdl_f_gas_3_Morph1_0,$pdl_color_Morph1_0,$pdl_Morph1_0<14);


plscol0a(0,0,0,0,1);
plcol0(0);
plvpor (0.085, 0.355, 0.10, 0.27);
plwind ($x_min1,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcnst", "bcnstv");
pllab($label1_1,"","");
$symbol=0;
plscatter($pdl_f_gas_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_NII_BR,my $pdl_fden_BPT_NII_BR, my $pdl_levels_NII_BR)=density_map_XY($pdl_f_gas_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_BR->at(10),$pdl_levels_NII_BR->at(50),$pdl_levels_NII_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
########
# E/S0/S0a
(my $pdl_den_BPT_NII_Morph0,my $pdl_fden_BPT_NII_Morph0, my $pdl_levels_NII_Morph0)=density_map_XY($pdl_f_gas_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph0->at(10),$pdl_levels_NII_Morph0->at(50),$pdl_levels_NII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_NII_Morph1,my $pdl_fden_BPT_NII_Morph1, my $pdl_levels_NII_Morph1)=density_map_XY($pdl_f_gas_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph1->at(10),$pdl_levels_NII_Morph1->at(50),$pdl_levels_NII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_NII_Morph2,my $pdl_fden_BPT_NII_Morph2, my $pdl_levels_NII_Morph2)=density_map_XY($pdl_f_gas_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+$dx,0,$dy,$y_min1+$dy);
@levels=($pdl_levels_NII_Morph2->at(10),$pdl_levels_NII_Morph2->at(50),$pdl_levels_NII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_NII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######


plcol0(0);
plwidth(2);
pllsty(1);
##plline($pdl_cut_x,$pdl_cut_y4);
pllsty(2);
##plline($pdl_cut_x,$pdl_cut_y3);
pllsty(1);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.1);
$pdl_cut_y_OIII_AGNs_sec=$pdl_cut_y_OIII_AGNs->where($pdl_cut_x>-0.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OIII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT SII
plvpor(0.355, 0.625, 0.10, 0.27);
plwind ($x_min1+0.4,$x_max1,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcnst", "bcstv");
pllab($label1_2,"","");
$symbol=0;
plscatter($pdl_f_gas_2_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_SII_BR,my $pdl_fden_BPT_SII_BR, my $pdl_levels_SII_BR)=density_map_XY($pdl_f_gas_2_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.4)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1+0.5*$dx,0,$dy,$y_min1+$0.5*$dy);
@levels=($pdl_levels_SII_BR->at(10),$pdl_levels_SII_BR->at(50),$pdl_levels_SII_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);

########
# E/S0/S0a
(my $pdl_den_BPT_SII_Morph0,my $pdl_fden_BPT_SII_Morph0, my $pdl_levels_SII_Morph0)=density_map_XY($pdl_f_gas_2_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph0->at(10),$pdl_levels_SII_Morph0->at(50),$pdl_levels_SII_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_SII_Morph1,my $pdl_fden_BPT_SII_Morph1, my $pdl_levels_SII_Morph1)=density_map_XY($pdl_f_gas_2_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph1->at(10),$pdl_levels_SII_Morph1->at(50),$pdl_levels_SII_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_SII_Morph2,my $pdl_fden_BPT_SII_Morph2, my $pdl_levels_SII_Morph2)=density_map_XY($pdl_f_gas_2_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1+0.4,$x_max1,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_SII_Morph2->at(10),$pdl_levels_SII_Morph2->at(50),$pdl_levels_SII_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_SII_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######
plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_SII);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-0.25);
$pdl_cut_y_SII_AGNs_sec=$pdl_cut_y_SII_AGNs->where($pdl_cut_x>-0.25);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_SII_AGNs_sec);
pllsty(1);
plwidth(1);

# BPT OI
plvpor (0.625, 0.895, 0.10, 0.27);
plwind ($x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1);
plbox (0.25, 0.1, 0.25, 0.1, "lbcnst", "bcstv");
pllab($label1_3,"","");
$symbol=0;
$pdl_f_gas_3->inplace->setvaltobad(0);
plscatter($pdl_f_gas_3_BR,$pdl_lambda_Re_BR,$symbol,$size,$n_ang,$pdl_color_BR,0,0,0);
(my $pdl_den_BPT_OI_BR,my $pdl_fden_BPT_OI_BR, my $pdl_levels_OI_BR)=density_map_XY($pdl_f_gas_3_BR,$pdl_lambda_Re_BR,$pdl_color_BR,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
my $dx=($x_max1-$x_min1-0.2+1.1)/$NX;
my $dy=($y_max1-$y_min1)/$NY;
@tr=($dx,0,$x_min1-1.1,0,$dy,$y_min1);
@levels=($pdl_levels_OI_BR->at(10),$pdl_levels_OI_BR->at(50),$pdl_levels_OI_BR(95));
plcol0(0);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_BR, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);

########
# E/S0/S0a
(my $pdl_den_BPT_OI_Morph0,my $pdl_fden_BPT_OI_Morph0, my $pdl_levels_OI_Morph0)=density_map_XY($pdl_f_gas_3_Morph0,$pdl_lambda_Re_Morph0,$pdl_color_Morph0,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph0->at(10),$pdl_levels_OI_Morph0->at(50),$pdl_levels_OI_Morph0->at(95));
plcol0(20);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph0, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sa/Sab/Sb
(my $pdl_den_BPT_OI_Morph1,my $pdl_fden_BPT_OI_Morph1, my $pdl_levels_OI_Morph1)=density_map_XY($pdl_f_gas_3_Morph1,$pdl_lambda_Re_Morph1,$pdl_color_Morph1,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph1->at(10),$pdl_levels_OI_Morph1->at(50),$pdl_levels_OI_Morph1->at(95));
plcol0(128);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph1, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
####
# Sbc/Sc/Sd
(my $pdl_den_BPT_OI_Morph2,my $pdl_fden_BPT_OI_Morph2, my $pdl_levels_OI_Morph2)=density_map_XY($pdl_f_gas_3_Morph2,$pdl_lambda_Re_Morph2,$pdl_color_Morph2,$x_min1-1.1,$x_max1-0.2,$y_min1,$y_max1,$NX,$NY);
@levels=($pdl_levels_OI_Morph2->at(10),$pdl_levels_OI_Morph2->at(50),$pdl_levels_OI_Morph2->at(95));
plcol0(255);
plwidth(2.0);
plcont ($pdl_den_BPT_OI_Morph2, 1, $NX, 1, $NX, pdl(@levels), \&mypltr, 0);
#######
plcol0(0);
plwidth(2);
##plline($pdl_cut_x,$pdl_cut_y_OI);
$pdl_cut_x_sec=$pdl_cut_x->where($pdl_cut_x>-1.1);
$pdl_cut_y_OI_AGNs_sec=$pdl_cut_y_OI_AGNs->where($pdl_cut_x>-1.1);
pllsty(3);
##plline($pdl_cut_x_sec,$pdl_cut_y_OI_AGNs_sec);
pllsty(1);
plwidth(1);

######################

#READ_cmap_plplot1_r("/home/sanchez/sda2/code/colortables/magma.csv",0.7);
#my @stats=stats($pdl_color);
#my $zmin=$stats[3];
#my $zmax=$stats[4];

plcol0(0);
READ_cmap_plplot1_r($pl_colormap1,0.5);
plcolorbar(0.90, 0.93, 0.15, 0.95,0,$zmin,$zmax,$label_cb,2.65,0,-2);
plvpor (0.1, 0.895, 0.17, 0.95);
plmtex(3.2,0,-1.8,"l",$label2);
plend();

#########################################################################
# BPT diagram GNUPLOT
#########################################################################

exit;
